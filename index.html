<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing Test Pro - Advanced</title>

    <!-- Google Fonts for better typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>

    <style>
        :root {
            --bg-gradient-start: #f8fbff;
            --bg-gradient-end: #eff6ff;
            --text-color: #1f2937;
            --card-bg: #ffffff;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --focus-ring: 0 0 0 3px rgba(59, 130, 246, 0.4);
            --error-color: #dc2626;
        }

        body {
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: var(--bg-gradient-start);
            background-image: linear-gradient(to bottom right, var(--bg-gradient-start), var(--bg-gradient-end));
            color: var(--text-color);
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
        }

        .logo-container {
            text-align: left;
        }

        .logo-container .logo {
            font-size: 1.8em;
            font-weight: 700;
            cursor: pointer;
            color: var(--primary-color);
            margin: 0;
            line-height: 1;
        }

        .logo-container .subtitle {
            font-size: 0.8em;
            font-weight: 600;
            color: #6b7280;
            margin: 0;
            margin-top: 2px;
        }

        header nav {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        header nav a {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            text-decoration: none;
            color: #4b5563;
            font-weight: 500;
            transition: all 0.2s;
            border-radius: 8px;
        }
        header nav a:hover {
            background-color: #eef2ff;
            color: var(--primary-color);
        }
        header nav .fas, header nav .far {
            font-size: 1.1em;
        }

        header nav a.nav-active {
            color: var(--primary-color);
            font-weight: 700;
            background-color: #eef2ff;
        }

        /* Utility */
        .hidden { display: none !important; }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: 1px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            margin: 5px;
            transition: all 0.2s ease-in-out;
            font-family: inherit;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: #fff;
        }
        .btn-primary:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn-secondary {
            background-color: #eef2ff;
            color: var(--primary-color);
            border-color: #dbeafe;
        }
        .btn-secondary:hover {
             background-color: #dbeafe;
        }

        /* Card Styles */
        .card {
            background-color: var(--card-bg);
            padding: 40px;
            border-radius: 24px;
            box-shadow: var(--card-shadow);
            max-width: 700px;
            margin: 20px auto;
        }
        .card h1, .card h2 { font-size: 2.5em; margin-bottom: 10px; text-align: center; font-weight: 700; }
        .card p { font-size: 1.1em; color: #6b7280; margin-bottom: 30px; text-align: center; }

        /* Home Screen */
        .hero-stats { display: flex; justify-content: center; gap: 40px; margin-bottom: 30px; }
        .hero-stat .stat-value { font-size: 2.5em; font-weight: 700; }
        .hero-stat .stat-label { font-size: 1em; color: #6b7280; }

        .presets-section { margin-top: 40px; }
        .presets-title { font-size: 1.4em; font-weight: 600; color: #4b5563; text-align: center; margin-bottom: 20px; }
        .preset-group { margin-bottom: 25px; }
        .preset-group h4 { font-weight: 500; color: #6b7280; margin-bottom: 10px; text-align: center; }
        .preset-buttons { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }

        /* Typing Test Area */
        #stats { display: flex; justify-content: space-around; align-items: center; margin-bottom: 20px; padding: 20px; background-color: var(--card-bg); border-radius: 16px; box-shadow: var(--card-shadow); }
        .stat { text-align: center; }
        .stat-value { font-size: 2em; font-weight: bold; }
        .stat-label { font-size: 0.8em; text-transform: uppercase; color: #6b7280; }
        
        /* --- NEW: Restart Button Style --- */
        #restart-test-btn {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 1.5em;
            cursor: pointer;
            transition: color 0.2s, transform 0.2s;
        }
        #restart-test-btn:hover {
            color: var(--primary-color);
            transform: rotate(90deg);
        }

        #typing-area {
            font-size: 1.6em;
            line-height: 1.8;
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            max-height: 140px;
            overflow-y: auto;
            -webkit-mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
            mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
        }

        #text-to-type span.correct { color: #16a34a; }
        #text-to-type span.incorrect { color: var(--error-color); text-decoration: underline; }
        #text-to-type span.current { background-color: rgba(59, 130, 246, 0.2); border-radius: 3px; }
        #text-input { width: 100%; padding: 10px; font-size: 1em; border: 2px solid #d1d5db; border-radius: 8px; margin-top: 20px; font-family: inherit; }

        /* Leaderboard */
        #leaderboard-list { list-style-type: none; padding: 0; }
        #leaderboard-list li { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #e5e7eb; font-size: 1.2em; }
        #leaderboard-list li .rank { font-weight: bold; min-width: 40px; color: var(--primary-color); }
        #leaderboard-list li .email { flex-grow: 1; color: #374151; word-break: break-all; }
        #leaderboard-list li .wpm { font-weight: 600; }
        
        /* Profile Screen CSS */
        #profile-stats-container { display: flex; flex-direction: column; gap: 25px; margin-top: 20px; }
        .profile-test-record { background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; }
        .profile-test-record h3 { margin-top: 0; margin-bottom: 15px; font-size: 1.3em; font-weight: 600; color: var(--primary-color); text-align: left; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .profile-test-record .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; text-align: center; }
        .profile-test-record .stat-value { font-size: 1.8em; font-weight: 600; display: block; color: #1f2937; }
        .profile-test-record .stat-label { font-size: 0.8em; text-transform: uppercase; color: #6b7280; }

        /* Form Styles */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input { width: 100%; padding: 12px; font-size: 1em; border: 1px solid #d1d5db; border-radius: 8px; box-sizing: border-box; }
        .error-message { color: var(--error-color); text-align: center; margin-top: 15px; }
        .form-switch-link { text-align: center; margin-top: 25px; font-size: 1em; color: #6b7280; }
        .form-switch-link a { color: var(--primary-color); font-weight: 600; text-decoration: none; cursor: pointer; }
        .form-switch-link a:hover { text-decoration: underline; }

        /* Custom Text Screen Specific Styles */
        #custom-text-input {
            width: 100%;
            box-sizing: border-box;
            padding: 15px;
            font-size: 1em;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            margin-bottom: 20px;
            font-family: inherit;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            header { flex-direction: column; gap: 10px; padding: 15px; }
            .card { padding: 20px; }
            .card h1, .card h2 { font-size: 1.8em; }
            .hero-stats { gap: 20px; }
            .hero-stat .stat-value { font-size: 2em; }
            #typing-area { font-size: 1.2em; max-height: 120px; }
            #stats { flex-wrap: wrap; gap: 15px; }
            .stat-value { font-size: 1.5em; }
            header nav a { padding: 8px 10px; gap: 5px; }
            header nav .nav-text { display: none; }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo-container">
            <h1 class="logo">TypingPro</h1>
            <p class="subtitle">Power by ATIK APP STUDIO</p>
        </div>
        <nav>
            <div id="guest-nav">
                <a href="#" id="login-nav-btn"><i class="fas fa-sign-in-alt"></i><span class="nav-text">Login</span></a>
                <a href="#" id="register-nav-btn"><i class="fas fa-user-plus"></i><span class="nav-text">Register</span></a>
            </div>
            <div id="user-nav" class="hidden">
                <a href="#" id="home-link"><i class="fas fa-home"></i><span class="nav-text">Home</span></a>
                <a href="#" id="profile-link"><i class="fas fa-user-cog"></i><span class="nav-text">Profile</span></a>
                <a href="#" id="leaderboard-link"><i class="fas fa-trophy"></i><span class="nav-text">Leaderboard</span></a>
                <a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i><span class="nav-text">Logout</span></a>
            </div>
        </nav>
    </header>

    <main class="container">
        <!-- Screens -->
        <section id="home-screen" class="card">
             <h1>Master Your Keystrokes</h1>
             <p>Select a test below or use your own text to practice.</p>
             <div class="hero-stats">
                 <div class="hero-stat">
                     <div class="stat-value" id="home-best-wpm">--</div>
                     <div class="stat-label">Best WPM</div>
                 </div>
                 <div class="hero-stat">
                     <div class="stat-value" id="home-tests-taken">--</div>
                     <div class="stat-label">Tests Taken</div>
                 </div>
             </div>

             <div class="presets-section">
                <h3 class="presets-title">Choose a Test Preset</h3>
                 <div class="preset-group">
                    <h4>Custom Text</h4>
                    <div class="preset-buttons">
                        <button id="custom-text-btn" class="btn btn-primary">Practice with Custom Text</button>
                    </div>
                </div>
                <div id="quick-start-buttons">
                    <div class="preset-group">
                        <h4>Seconds</h4>
                        <div class="preset-buttons">
                            <button class="btn btn-secondary" data-mode="time" data-duration="15">15s</button>
                            <button class="btn btn-secondary" data-mode="time" data-duration="30">30s</button>
                            <button class="btn btn-secondary" data-mode="time" data-duration="60">60s</button>
                        </div>
                    </div>
                     <div class="preset-group">
                        <h4>Minutes</h4>
                        <div class="preset-buttons">
                            <button class="btn btn-secondary" data-mode="time" data-duration="120">2 min</button>
                            <button class="btn btn-secondary" data-mode="time" data-duration="180">3 min</button>
                            <button class="btn btn-secondary" data-mode="time" data-duration="300">5 min</button>
                            <button class="btn btn-secondary" data-mode="time" data-duration="600">10 min</button>
                            <button class="btn btn-secondary" data-mode="time" data-duration="900">15 min</button>
                            <button class="btn btn-secondary" data-mode="time" data-duration="1200">20 min</button>
                        </div>
                    </div>
                    <div class="preset-group">
                        <h4>Words</h4>
                        <div class="preset-buttons">
                            <button class="btn btn-secondary" data-mode="words" data-count="50">50 words</button>
                        </div>
                    </div>
                </div>
             </div>
        </section>
        
        <section id="custom-text-screen" class="hidden card">
            <h2>Custom Text Practice</h2>
            <p>Paste your text below (minimum 20 characters) and start typing!</p>
            <textarea id="custom-text-input" rows="8" placeholder="Paste your text here..."></textarea>
            <div style="text-align: center;">
                <button id="start-custom-test-btn" class="btn btn-primary">Start Custom Test</button>
                <button id="custom-back-home-btn" class="btn btn-secondary">Back to Home</button>
            </div>
        </section>

        <section id="typing-test-screen" class="hidden">
            <div id="stats">
                <div class="stat"><div id="wpm" class="stat-value">0</div><div class="stat-label">WPM</div></div>
                <div class="stat"><div id="cpm" class="stat-value">0</div><div class="stat-label">CPM</div></div>
                <div class="stat"><div id="accuracy" class="stat-value">100</div><div class="stat-label">Accuracy</div></div>
                <div class="stat"><div id="timer" class="stat-value">0</div><div class="stat-label">Time</div></div>
                <!-- NEW: Restart button added here -->
                <div class="stat">
                    <button id="restart-test-btn" title="Restart Test"><i class="fas fa-redo"></i></button>
                </div>
            </div>
            <div id="typing-area">
                <div id="text-to-type"></div>
            </div>
            <textarea id="text-input" rows="1" spellcheck="false" autocorrect="off" autocapitalize="off"></textarea>
            <div style="text-align: center; margin-top: 20px;">
                <button id="end-test-btn" class="btn btn-primary">End Test</button>
            </div>
        </section>

        <section id="result-screen" class="hidden card">
            <h2>Test Results</h2>
            <div id="result-summary" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0; font-size: 1.2em; text-align: center;"></div>
            <button id="retry-btn" class="btn btn-primary">Try Again</button>
            <button id="home-btn" class="btn">Go Home</button>
        </section>

        <!-- Other screens (login, register, etc.) are unchanged -->
        <section id="login-screen" class="hidden card">
            <h2>Login</h2>
            <form id="login-form">
                <div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" required></div>
                <div class="form-group"><label for="login-password">Password</label><input type="password" id="login-password" required></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
                <p id="login-error" class="error-message hidden"></p>
                <p class="form-switch-link">Don't have an account? <a id="go-to-register">Register</a></p>
            </form>
        </section>

        <section id="register-screen" class="hidden card">
            <h2>Register</h2>
            <form id="register-form">
                <div class="form-group"><label for="register-email">Email</label><input type="email" id="register-email" required></div>
                <div class="form-group"><label for="register-password">Password</label><input type="password" id="register-password" required></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Register</button>
                <p id="register-error" class="error-message hidden"></p>
                <p class="form-switch-link">Already have an account? <a id="go-to-login">Login</a></p>
            </form>
        </section>

        <section id="leaderboard-screen" class="hidden card">
            <h2>Leaderboard</h2>
            <p>Top 10 Fastest Typists</p>
            <ol id="leaderboard-list"></ol>
        </section>

        <section id="profile-screen" class="hidden card">
            <h2>My Profile</h2>
            <p id="profile-email">user@example.com</p>
            <div id="profile-stats-container"></div>
            <button id="profile-back-home-btn" class="btn btn-secondary">Go Home</button>
        </section>
    </main>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDZrP8uuHQOSlU5rnQqmJ-_mKYs6GaO_AA",
            authDomain: "all-app-er.firebaseapp.com",
            databaseURL: "https://all-app-er-default-rtdb.firebaseio.com",
            projectId: "all-app-er",
            storageBucket: "all-app-er.appspot.com",
            messagingSenderId: "166378015396",
            appId: "1:166378015396:web:48cfb3cfa81611d7627431"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // --- Paragraphs for Typing Test ---
        const textPool = [
            "The quick brown fox jumps over the lazy dog. This sentence contains every letter of the alphabet.",
            "A journey of a thousand miles begins with a single step. Lao Tzu said this to emphasize that great things start with small beginnings.",
            "To be or not to be that is the question. A famous line from William Shakespeare's play Hamlet.",
            "The internet has revolutionized the way we live, work, and communicate. It connects billions of people worldwide.",
            "Artificial intelligence is no longer the realm of science fiction; it is an integral part of our daily lives.",
            "Cloud computing has fundamentally changed the information technology landscape by offering scalability and flexibility.",
            "The early bird catches the worm. This proverb suggests that starting something early gives you a better chance of success.",
            "Actions speak louder than words. It is more important what you do than what you say.",
            "Honesty is the best policy. It is always better to tell the truth, even when it is difficult.",
            "Practice makes perfect. The more you do something, the better you will become at it.",
            "Where there is a will there is a way. If you are determined enough, you can find a way to achieve what you want."
        ];
        
        // --- NEW: A temporary pool for endless mode to avoid immediate repetition ---
        let endlessModeTextPool = [];

        // --- DOM Elements & State ---
        const allScreens = document.querySelectorAll('main > section');
        const textToType = document.getElementById('text-to-type');
        const textInput = document.getElementById('text-input');
        let currentScreenId = 'home-screen';
        let timerInterval, testActive, startTime, lastTestConfig = {}, mistakes, typedChars;

        // --- START: Navigation and History Management ---
        function showScreen(screenId, pushState = true) {
            if (!document.getElementById(screenId)) {
                console.error("Screen not found:", screenId);
                return;
            }
            allScreens.forEach(screen => screen.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            currentScreenId = screenId;
            if (pushState) {
                const newPath = (screenId === 'home-screen') ? window.location.pathname : `#${screenId}`;
                history.pushState({ screen: screenId }, '', newPath);
            }
            updateActiveNav(screenId);
        }

        function updateActiveNav(screenId) {
            document.querySelectorAll('#user-nav a').forEach(link => link.classList.remove('nav-active'));
            let activeLink;
            switch(screenId) {
                case 'home-screen': case 'custom-text-screen': case 'typing-test-screen': case 'result-screen':
                    activeLink = document.getElementById('home-link'); break;
                case 'profile-screen': activeLink = document.getElementById('profile-link'); break;
                case 'leaderboard-screen': activeLink = document.getElementById('leaderboard-link'); break;
            }
            if (activeLink) activeLink.classList.add('nav-active');
        }

        window.addEventListener('popstate', (event) => {
            const targetScreen = (event.state && event.state.screen) || 'home-screen';
            showScreen(targetScreen, false);
        });

        function navigateHome() { showScreen('home-screen', true); }
        // --- END: Navigation and History Management ---

        // --- NEW: Endless Mode Logic ---
        function generateMoreText() {
            if (endlessModeTextPool.length === 0) {
                endlessModeTextPool = shuffleArray(textPool); // Refill the pool if it's empty
            }
            const newText = endlessModeTextPool.pop(); // Get one sentence from the temp pool
            
            // Add a space before appending the new text
            const spaceSpan = document.createElement('span');
            spaceSpan.innerText = ' ';
            textToType.appendChild(spaceSpan);

            // Add the new text character by character
            newText.split('').forEach(char => {
                const span = document.createElement('span');
                span.innerText = char;
                textToType.appendChild(span);
            });
        }
        
        // --- NEW: Restart Test Logic ---
        function restartTest() {
            if (!testActive) return; // Only works if a test is active
            clearInterval(timerInterval); // Stop the current timer
            // Start a new test with the same configuration but new text
            startTest(lastTestConfig.mode, lastTestConfig.value, lastTestConfig.customText);
        }

        // --- Core Application Logic ---
        function shuffleArray(arr) { return [...arr].sort(() => Math.random() - 0.5); }
        
        function setupTextForTest(text) {
            textToType.innerHTML = '';
            text.split('').forEach(char => {
                const span = document.createElement('span');
                span.innerText = char;
                textToType.appendChild(span);
            });
        }
        
        function startTest(mode, value, customText = null) {
            lastTestConfig = { mode, value, customText };
            testActive = true;
            startTime = null;
            mistakes = 0;
            typedChars = 0;
            textInput.value = '';
            textInput.disabled = false;
            
            let textToUse;
            if (customText) {
                textToUse = customText;
            } else if (mode === 'time') {
                // For time mode, start with a smaller chunk and generate more later
                endlessModeTextPool = shuffleArray(textPool);
                textToUse = endlessModeTextPool.slice(0, 3).join(" ");
            } else {
                // For word mode, use a fixed text block
                textToUse = shuffleArray(textPool).slice(0, 10).join(" ");
            }

            setupTextForTest(textToUse);
            showScreen('typing-test-screen');
            textInput.focus();
            
            let timerLabel = "0";
            if (mode === 'time') timerLabel = value;
            document.getElementById('timer').innerText = timerLabel;
            
            updateCursor();
            resetLiveStats();
        }

        function endTest() {
            if (!testActive) return;
            testActive = false;
            clearInterval(timerInterval);
            textInput.disabled = true;
            const results = calculateFinalStats();
            displayResults(results);
            saveResultsToFirebase(results, lastTestConfig);
            showScreen('result-screen');
        }

        function calculateFinalStats() {
            if (!startTime) return { wpm: 0, cpm: 0, accuracy: 100, mistakes: 0 };
            const timeElapsedSeconds = (new Date().getTime() - startTime) / 1000;
            const correctChars = typedChars - mistakes;
            const wpm = timeElapsedSeconds > 0 ? Math.round((correctChars / 5) / (timeElapsedSeconds / 60)) : 0;
            const cpm = timeElapsedSeconds > 0 ? Math.round(correctChars / (timeElapsedSeconds / 60)) : 0;
            const accuracy = typedChars > 0 ? Math.round((correctChars / typedChars) * 100) : 100;
            return { wpm, cpm, accuracy: Math.max(0, accuracy), mistakes };
        }

        function displayResults({ wpm, cpm, accuracy, mistakes }) {
            document.getElementById('result-summary').innerHTML = `
                <div><span class="stat-value">${wpm}</span><br><span class="stat-label">WPM</span></div>
                <div><span class="stat-value">${cpm}</span><br><span class="stat-label">CPM</span></div>
                <div><span class="stat-value">${accuracy}%</span><br><span class="stat-label">Accuracy</span></div>
                <div><span class="stat-value">${mistakes}</span><br><span class="stat-label">Mistakes</span></div>`;
        }

        function updateLiveStats() {
            if (!startTime) return;
            const stats = calculateFinalStats();
            document.getElementById('wpm').innerText = stats.wpm;
            document.getElementById('cpm').innerText = stats.cpm;
            document.getElementById('accuracy').innerText = stats.accuracy;
        }

        function resetLiveStats() {
            document.getElementById('wpm').innerText = 0;
            document.getElementById('cpm').innerText = 0;
            document.getElementById('accuracy').innerText = 100;
        }

        function updateCursor() {
            const textSpans = textToType.querySelectorAll('span');
            textSpans.forEach(span => span.classList.remove('current'));
            const currentPos = textInput.value.length;
            if (currentPos < textSpans.length) {
                const cursorSpan = textSpans[currentPos];
                cursorSpan.classList.add('current');
                cursorSpan.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // --- Firebase & Auth Logic (Unchanged) ---
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('guest-nav').classList.add('hidden');
                document.getElementById('user-nav').classList.remove('hidden');
                fetchUserStats(user.uid);
            } else {
                document.getElementById('guest-nav').classList.remove('hidden');
                document.getElementById('user-nav').classList.add('hidden');
                document.getElementById('home-best-wpm').innerText = '--';
                document.getElementById('home-tests-taken').innerText = '--';
            }
            if (currentScreenId !== 'home-screen' && !user) {
                 showScreen('home-screen', false);
                 history.replaceState({screen: 'home-screen'}, '', window.location.pathname);
            }
            updateActiveNav(currentScreenId);
        });
        function fetchUserStats(uid) {
            db.ref(`users/${uid}`).once('value', snapshot => {
                if (snapshot.exists()) {
                    const stats = snapshot.val();
                    document.getElementById('home-best-wpm').innerText = stats.overallBestWpm || 0;
                    document.getElementById('home-tests-taken').innerText = stats.testsTaken || 0;
                }
            });
        }
        async function saveResultsToFirebase(results, { mode, value }) {
            const user = auth.currentUser;
            if (!user || results.wpm === 0 || !mode || !value || mode === 'custom') return;
            const testKey = `${mode}_${value}`;
            const userStatsRef = db.ref(`users/${user.uid}`);
            const leaderboardRef = db.ref(`leaderboard/${user.uid}`);
            try {
                const snapshot = await userStatsRef.once('value');
                const stats = snapshot.val() || { email: user.email, testsTaken: 0, overallBestWpm: 0, scores: {} };
                const currentBestForTest = (stats.scores && stats.scores[testKey]) ? stats.scores[testKey] : { wpm: 0 };
                if (results.wpm > currentBestForTest.wpm) {
                    if (!stats.scores) stats.scores = {};
                    stats.scores[testKey] = results;
                }
                const newOverallBest = Math.max(stats.overallBestWpm || 0, results.wpm);
                const updates = {
                    testsTaken: (stats.testsTaken || 0) + 1,
                    overallBestWpm: newOverallBest,
                    scores: stats.scores,
                    email: user.email
                };
                await userStatsRef.update(updates);
                await leaderboardRef.set({ email: user.email, wpm: newOverallBest });
                fetchUserStats(user.uid);
            } catch (error) {
                console.error("Error saving results: ", error);
            }
        }
        async function showLeaderboard() {
            showScreen('leaderboard-screen');
            const leaderboardList = document.getElementById('leaderboard-list');
            leaderboardList.innerHTML = '<li>Loading...</li>';
            try {
                const snapshot = await db.ref('leaderboard').orderByChild('wpm').limitToLast(10).once('value');
                if (snapshot.exists()) {
                    const scores = [];
                    snapshot.forEach(child => scores.push(child.val()));
                    leaderboardList.innerHTML = scores.reverse().map((score, index) =>
                        `<li><span class="rank">${index + 1}</span><span class="email">${score.email}</span><span class="wpm">${score.wpm} WPM</span></li>`
                    ).join('');
                } else { leaderboardList.innerHTML = '<li>No scores yet. Be the first!</li>'; }
            } catch (error) {
                console.error("Failed to load leaderboard:", error);
                leaderboardList.innerHTML = '<li>Could not load scores. Please check your connection or try again later.</li>';
            }
        }
        async function showProfileScreen() {
            const user = auth.currentUser;
            if (!user) { showScreen('login-screen'); return; }
            showScreen('profile-screen');
            const profileContainer = document.getElementById('profile-stats-container');
            document.getElementById('profile-email').innerText = user.email;
            profileContainer.innerHTML = '<p>Loading your best scores...</p>';
            const createLabelFromKey = (key) => {
                const [type, value] = key.split('_');
                if (type === 'time') {
                    const seconds = parseInt(value, 10);
                    return seconds >= 60 ? `${seconds / 60} Minute${seconds > 60 ? 's' : ''} Best` : `${seconds} Second${seconds > 1 ? 's' : ''} Best`;
                }
                return type === 'words' ? `${value} Word${parseInt(value, 10) > 1 ? 's' : ''} Best` : key;
            };
            try {
                const snapshot = await db.ref(`users/${user.uid}/scores`).once('value');
                const scores = snapshot.val() || {};
                const scoreKeys = Object.keys(scores);
                let profileHtml = '';
                if (scoreKeys.length === 0) {
                     profileHtml = '<p>You have not completed any tests yet. Go take one!</p>';
                } else {
                    scoreKeys.sort((a, b) => {
                        const [typeA, valA] = a.split('_');
                        const [typeB, valB] = b.split('_');
                        if (typeA !== typeB) return typeA.localeCompare(typeB);
                        return parseInt(valA, 10) - parseInt(valB, 10);
                    }).forEach(key => {
                        const scoreData = scores[key];
                        if (scoreData) {
                            profileHtml += `
                                <div class="profile-test-record">
                                    <h3>${createLabelFromKey(key)}</h3>
                                    <div class="stats-grid">
                                        <div><span class="stat-value">${scoreData.wpm}</span><span class="stat-label">WPM</span></div>
                                        <div><span class="stat-value">${scoreData.cpm}</span><span class="stat-label">CPM</span></div>
                                        <div><span class="stat-value">${scoreData.accuracy}%</span><span class="stat-label">Accuracy</span></div>
                                        <div><span class="stat-value">${scoreData.mistakes}</span><span class="stat-label">Mistakes</span></div>
                                    </div>
                                </div>`;
                        }
                    });
                }
                profileContainer.innerHTML = profileHtml || '<p>You have not completed any tests yet. Go take one!</p>';
            } catch (error) {
                console.error("Could not load profile stats:", error);
                profileContainer.innerHTML = '<p>Could not load your stats. Please try again.</p>';
            }
        }

        // --- Event Listeners ---
        function preventDefault(e) { e.preventDefault(); }
        document.querySelector('.logo-container').addEventListener('click', (e) => { preventDefault(e); navigateHome(); });
        document.getElementById('login-nav-btn').addEventListener('click', (e) => { preventDefault(e); showScreen('login-screen'); });
        document.getElementById('register-nav-btn').addEventListener('click', (e) => { preventDefault(e); showScreen('register-screen'); });
        document.getElementById('leaderboard-link').addEventListener('click', (e) => { preventDefault(e); showLeaderboard(); });
        document.getElementById('logout-btn').addEventListener('click', (e) => { preventDefault(e); auth.signOut().then(navigateHome); });
        document.getElementById('home-link').addEventListener('click', (e) => { preventDefault(e); navigateHome(); });
        document.getElementById('home-btn').addEventListener('click', (e) => { preventDefault(e); navigateHome(); });
        document.getElementById('profile-link').addEventListener('click', (e) => { preventDefault(e); showProfileScreen(); });
        document.getElementById('profile-back-home-btn').addEventListener('click', (e) => { preventDefault(e); navigateHome(); });
        document.getElementById('go-to-register').addEventListener('click', (e) => { preventDefault(e); showScreen('register-screen'); });
        document.getElementById('go-to-login').addEventListener('click', (e) => { preventDefault(e); showScreen('login-screen'); });

        document.getElementById('login-form').addEventListener('submit', (e) => {
            preventDefault(e);
            const errEl = document.getElementById('login-error');
            errEl.classList.add('hidden');
            auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value)
                .then(() => navigateHome())
                .catch(err => { errEl.innerText = err.message; errEl.classList.remove('hidden'); });
        });
        document.getElementById('register-form').addEventListener('submit', (e) => {
            preventDefault(e);
            const errEl = document.getElementById('register-error');
            errEl.classList.add('hidden');
            auth.createUserWithEmailAndPassword(document.getElementById('register-email').value, document.getElementById('register-password').value)
                .then(() => navigateHome())
                .catch(err => { errEl.innerText = err.message; errEl.classList.remove('hidden'); });
        });
        
        document.getElementById('quick-start-buttons').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.mode) {
                startTest(e.target.dataset.mode, parseInt(e.target.dataset.duration || e.target.dataset.count, 10));
            }
        });

        document.getElementById('custom-text-btn').addEventListener('click', () => showScreen('custom-text-screen'));
        document.getElementById('custom-back-home-btn').addEventListener('click', navigateHome);
        document.getElementById('start-custom-test-btn').addEventListener('click', () => {
            const customText = document.getElementById('custom-text-input').value.trim();
            if (customText.length >= 20) {
                startTest('custom', customText.length, customText);
            } else {
                alert('Please paste at least 20 characters of text to start.');
            }
        });

        document.getElementById('retry-btn').addEventListener('click', () => {
             if (lastTestConfig.mode) {
                startTest(lastTestConfig.mode, lastTestConfig.value, lastTestConfig.customText);
             } else {
                navigateHome();
             }
        });
        document.getElementById('end-test-btn').addEventListener('click', endTest);
        
        // --- MODIFIED: Event Listener for Restart Button ---
        document.getElementById('restart-test-btn').addEventListener('click', restartTest);

        textInput.addEventListener('input', () => {
            if (!testActive) return;
            if (!startTime) {
                startTime = new Date().getTime();
                if (lastTestConfig.mode === 'time') {
                     timerInterval = setInterval(() => {
                        const timeElapsed = Math.floor((new Date().getTime() - startTime) / 1000);
                        const timeRemaining = lastTestConfig.value - timeElapsed;
                        document.getElementById('timer').innerText = Math.max(0, timeRemaining);
                        if (timeRemaining <= 0) endTest();
                    }, 1000);
                }
            }
            const originalTextSpans = textToType.querySelectorAll('span');
            const currentTypedText = textInput.value;
            typedChars = currentTypedText.length;
            mistakes = 0;

            currentTypedText.split('').forEach((typedChar, index) => {
                if (index < originalTextSpans.length) {
                    const originalChar = originalTextSpans[index].innerText;
                    originalTextSpans[index].className = (typedChar === originalChar) ? 'correct' : 'incorrect';
                    if (typedChar !== originalChar) mistakes++;
                }
            });

            for (let i = typedChars; i < originalTextSpans.length; i++) {
                originalTextSpans[i].className = '';
            }
            
            // --- MODIFIED: Trigger for endless mode ---
            if (lastTestConfig.mode === 'time' && typedChars > originalTextSpans.length - 50) {
                generateMoreText();
            }

            if ((lastTestConfig.mode === 'words' || lastTestConfig.mode === 'custom') && typedChars === originalTextSpans.length) {
                endTest();
            }

            updateCursor();
            updateLiveStats();
        });

        // Initial Load
        document.addEventListener('DOMContentLoaded', () => {
            const initialScreen = window.location.hash.substring(1) || 'home-screen';
            if (document.getElementById(initialScreen)) {
                showScreen(initialScreen, false);
                history.replaceState({ screen: initialScreen }, '', window.location.pathname + (initialScreen !== 'home-screen' ? `#${initialScreen}` : ''));
            } else {
                showScreen('home-screen', false);
                history.replaceState({ screen: 'home-screen' }, '', window.location.pathname);
            }
        });
    </script>
</body>
</html>
