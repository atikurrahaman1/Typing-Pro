<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing Test Pro - Advanced</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
    <style>
        :root {
            --bg-primary: #f8fbff;
            --bg-secondary: #eff6ff;
            --text-color: #1f2937;
            --card-bg: #ffffff;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --secondary-color: #eef2ff;
            --secondary-hover: #dbeafe;
            --correct-color: #16a34a;
            --incorrect-color: #dc2626;
            --caret-color: #3b82f6;
            --gradient-1: linear-gradient(135deg, #3b82f6, #8b5cf6);
            --gradient-2: linear-gradient(135deg, #8b5cf6, #ec4899);
            --gradient-3: linear-gradient(135deg, #ec4899, #f43f5e);
            --dark-bg: #0f172a;
            --dark-card: #1e293b;
            --dark-text: #e2e8f0;
            --dark-secondary: #334155;
            --heatmap-high: #ef4444;
            --heatmap-medium: #f97316;
            --heatmap-low: #eab308;
            --heatmap-good: #22c55e;
        }
        
        /* Dark mode styles */
        body.dark-mode {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --text-color: #e2e8f0;
            --card-bg: #1e293b;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            --secondary-color: #334155;
            --secondary-hover: #475569;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            perspective: 1000px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            flex-grow: 1;
            transform-style: preserve-3d;
        }
        
        /* 3D Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            transform-style: preserve-3d;
            position: relative;
            z-index: 10;
        }
        
        .logo-container {
            text-align: left;
            transform: translateZ(20px);
            transition: transform 0.5s ease;
        }
        
        .logo-container:hover {
            transform: translateZ(30px) rotateY(5deg);
        }
        
        .logo-container .logo {
            font-family: 'Roboto Mono', monospace;
            font-size: 2.2em;
            font-weight: 700;
            cursor: pointer;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin: 0;
            line-height: 1;
            text-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
            transform-style: preserve-3d;
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0% { transform: translateY(0px) rotateZ(0deg); }
            50% { transform: translateY(-10px) rotateZ(2deg); }
            100% { transform: translateY(0px) rotateZ(0deg); }
        }
        
        .logo-container .subtitle {
            font-size: 0.8em;
            font-weight: 600;
            color: #6b7280;
            margin: 0;
            margin-top: 2px;
        }
        
        body.dark-mode .logo-container .subtitle {
            color: #94a3b8;
        }
        
        header nav {
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateZ(20px);
            transition: transform 0.5s ease;
        }
        
        header nav:hover {
            transform: translateZ(30px);
        }
        
        header nav a {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            text-decoration: none;
            color: #4b5563;
            font-weight: 500;
            transition: all 0.3s ease;
            border-radius: 8px;
            transform-style: preserve-3d;
            position: relative;
            overflow: hidden;
        }
        
        body.dark-mode header nav a {
            color: #cbd5e1;
        }
        
        header nav a::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-1);
            opacity: 0;
            z-index: -1;
            transition: opacity 0.3s ease;
            transform: translateZ(-10px);
        }
        
        header nav a:hover::before {
            opacity: 0.1;
        }
        
        header nav a:hover {
            transform: translateY(-3px) translateZ(10px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        header nav a.nav-active {
            color: var(--primary-color);
            font-weight: 700;
            background-color: var(--secondary-color);
            transform: translateZ(5px);
        }
        
        body.dark-mode header nav a.nav-active {
            background-color: var(--dark-secondary);
        }
        
        header nav .fas, header nav .far {
            font-size: 1.1em;
        }
        
        /* Dark mode toggle */
        .dark-mode-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient-2);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 100;
            transition: all 0.3s ease;
            transform-style: preserve-3d;
        }
        
        .dark-mode-toggle:hover {
            transform: translateY(-5px) rotateZ(180deg);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        /* Utility */
        .hidden { display: none !important; }
        
        /* 3D Buttons */
        .btn {
            padding: 10px 20px;
            border: 1px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            margin: 5px;
            transition: all 0.3s ease;
            font-family: inherit;
            transform-style: preserve-3d;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            transform: translateZ(-20px);
            transition: all 0.3s ease;
        }
        
        .btn:active {
            transform: translateY(2px) translateZ(5px);
        }
        
        .btn-primary {
            background: var(--gradient-1);
            color: #fff;
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px) translateZ(10px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            color: var(--primary-color);
            border-color: var(--secondary-hover);
        }
        
        body.dark-mode .btn-secondary {
            background-color: var(--dark-secondary);
            color: #93c5fd;
            border-color: #475569;
        }
        
        .btn-secondary:hover {
            background-color: var(--secondary-hover);
            transform: translateY(-3px) translateZ(10px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        /* Select */
        #time-test-dropdown {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%233b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 30px;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.3s ease;
        }
        
        #time-test-dropdown:hover {
            transform: translateY(-2px) translateZ(5px);
        }
        
        /* 3D Card Styles */
        .card {
            background-color: var(--card-bg);
            padding: 40px;
            border-radius: 24px;
            box-shadow: var(--card-shadow);
            max-width: 800px;
            margin: 20px auto;
            transform-style: preserve-3d;
            transition: all 0.5s ease;
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            z-index: 0;
            pointer-events: none;
        }
        
        body.dark-mode .card::before {
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0) 100%);
        }
        
        .card:hover {
            transform: translateY(-5px) rotateX(2deg);
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .card h1, .card h2 { 
            font-size: 2.5em; 
            margin-bottom: 10px; 
            text-align: center; 
            font-weight: 700;
            position: relative;
            z-index: 1;
        }
        
        .card p { 
            font-size: 1.1em; 
            color: #6b7280; 
            margin-bottom: 30px; 
            text-align: center;
            position: relative;
            z-index: 1;
        }
        
        body.dark-mode .card p {
            color: #94a3b8;
        }
        
        /* Home Screen */
        .hero-stats { 
            display: flex; 
            justify-content: center; 
            gap: 40px; 
            margin-bottom: 30px; 
        }
        
        .hero-stat { 
            padding: 20px;
            border-radius: 16px;
            background: var(--secondary-color);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transform-style: preserve-3d;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        body.dark-mode .hero-stat {
            background: var(--dark-secondary);
        }
        
        .hero-stat::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-1);
            opacity: 0.1;
            z-index: 0;
            transform: translateZ(-10px);
        }
        
        .hero-stat:hover {
            transform: translateY(-5px) translateZ(10px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .hero-stat .stat-value { 
            font-size: 2.5em; 
            font-weight: 700;
            position: relative;
            z-index: 1;
        }
        
        .hero-stat .stat-label { 
            font-size: 1em; 
            color: #6b7280;
            position: relative;
            z-index: 1;
        }
        
        body.dark-mode .hero-stat .stat-label {
            color: #94a3b8;
        }
        
        .presets-section { 
            margin-top: 40px; 
        }
        
        .presets-title { 
            font-size: 1.4em; 
            font-weight: 600; 
            color: #4b5563; 
            text-align: center; 
            margin-bottom: 20px;
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        body.dark-mode .presets-title {
            color: #cbd5e1;
        }
        
        .presets-title::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 3px;
            background: var(--gradient-1);
            border-radius: 3px;
        }
        
        .preset-group { 
            margin-bottom: 25px; 
        }
        
        .preset-group h4 { 
            font-weight: 500; 
            color: #6b7280; 
            text-align: center; 
            margin-bottom: 10px;
        }
        
        body.dark-mode .preset-group h4 {
            color: #94a3b8;
        }
        
        .preset-buttons { 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 15px; 
        }
        
        /* Typing Test Area */
        #stats { 
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            margin-bottom: 20px; 
            padding: 20px; 
            background-color: var(--card-bg); 
            border-radius: 16px; 
            box-shadow: var(--card-shadow);
            transform-style: preserve-3d;
            transition: all 0.3s ease;
        }
        
        #stats:hover {
            transform: translateY(-3px) rotateX(2deg);
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .stat { 
            text-align: center; 
            transform: translateZ(10px);
        }
        
        .stat-value { 
            font-size: 2em; 
            font-weight: bold;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .stat-label { 
            font-size: 0.8em; 
            text-transform: uppercase; 
            color: #6b7280;
        }
        
        body.dark-mode .stat-label {
            color: #94a3b8;
        }
        
        #restart-test-btn {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            transform-style: preserve-3d;
        }
        
        body.dark-mode #restart-test-btn {
            color: #64748b;
        }
        
        #restart-test-btn:hover {
            color: var(--primary-color);
            transform: rotate(90deg) translateZ(10px);
        }
        
        #typing-area {
            font-family: 'Roboto Mono', monospace;
            font-size: 1.6em;
            line-height: 1.8;
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            max-height: 140px;
            overflow-y: auto;
            -webkit-mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
            mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
            transform-style: preserve-3d;
            transition: all 0.3s ease;
            position: relative;
        }
        
        #typing-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            border-radius: 16px;
            z-index: 0;
            pointer-events: none;
        }
        
        #typing-area:hover {
            transform: translateY(-3px) rotateX(2deg);
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        #text-to-type span.correct { 
            color: var(--correct-color);
            text-shadow: 0 0 5px rgba(22, 163, 74, 0.3);
        }
        
        #text-to-type span.incorrect { 
            color: var(--incorrect-color); 
            text-decoration: underline;
            text-shadow: 0 0 5px rgba(220, 38, 38, 0.3);
        }
        
        #text-to-type span.current {
            background-color: var(--caret-color);
            border-radius: 3px;
            color: white;
            padding: 2px 0;
            margin-right: -2px;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        #text-input { 
            font-family: 'Roboto Mono', monospace;
            width: 100%; 
            padding: 10px; 
            font-size: 1em; 
            border: 2px solid #d1d5db; 
            border-radius: 8px; 
            margin-top: 20px; 
            font-family: inherit;
            background-color: var(--card-bg);
            color: var(--text-color);
            transform-style: preserve-3d;
            transition: all 0.3s ease;
        }
        
        body.dark-mode #text-input {
            border-color: #475569;
            background-color: var(--dark-secondary);
        }
        
        #text-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
            transform: translateY(-2px) translateZ(5px);
        }
        
        /* Leaderboard Styles */
        .leaderboard-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        
        .leaderboard-tabs button {
            background-color: var(--secondary-color);
            color: #4b5563;
            border: 1px solid var(--secondary-hover);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            transform-style: preserve-3d;
        }
        
        body.dark-mode .leaderboard-tabs button {
            background-color: var(--dark-secondary);
            color: #cbd5e1;
            border-color: #475569;
        }
        
        .leaderboard-tabs button:hover {
            background-color: var(--secondary-hover);
            transform: translateY(-2px) translateZ(5px);
        }
        
        .leaderboard-tabs button.active {
            background: var(--gradient-1);
            color: white;
            border-color: var(--primary-color);
            transform: translateZ(5px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }
        
        #leaderboard-content h3 {
            text-align: center;
            font-weight: 600;
            color: #374151;
            margin-bottom: 20px;
        }
        
        body.dark-mode #leaderboard-content h3 {
            color: #e2e8f0;
        }
        
        #leaderboard-list { 
            list-style-type: none; 
            padding: 0; 
            animation: fadeIn 0.5s ease-in-out;
            transform-style: preserve-3d;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        #leaderboard-list li { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px; 
            border-bottom: 1px solid #e5e7eb; 
            font-size: 1.2em;
            background-color: #f9fafb;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            transform-style: preserve-3d;
            position: relative;
        }
        
        body.dark-mode #leaderboard-list li {
            background-color: var(--dark-secondary);
            border-bottom: 1px solid #334155;
        }
        
        #leaderboard-list li:last-child { border-bottom: none; }
        
        #leaderboard-list li:hover { 
            transform: translateY(-5px) translateZ(10px) rotateX(2deg);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        #leaderboard-list li .rank { 
            font-weight: bold; 
            min-width: 40px; 
            color: var(--primary-color);
            font-size: 1.2em;
        }
        
        #leaderboard-list li .email { 
            flex-grow: 1; 
            color: #374151; 
            word-break: break-all; 
            margin: 0 15px;
        }
        
        body.dark-mode #leaderboard-list li .email {
            color: #e2e8f0;
        }
        
        #leaderboard-list li .wpm { 
            font-weight: 600; 
            color: var(--correct-color);
        }
        
        /* Profile Screen CSS */
        #profile-stats-container { 
            display: flex; 
            flex-direction: column; 
            gap: 25px; 
            margin-top: 20px;
        }
        
        .profile-test-record { 
            background-color: #f9fafb; 
            border: 1px solid #e5e7eb; 
            border-radius: 12px; 
            padding: 20px;
            transform-style: preserve-3d;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        body.dark-mode .profile-test-record {
            background-color: var(--dark-secondary);
            border: 1px solid #334155;
        }
        
        .profile-test-record::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-1);
            opacity: 0.05;
            z-index: 0;
            transform: translateZ(-10px);
        }
        
        .profile-test-record:hover {
            transform: translateY(-5px) translateZ(10px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .profile-test-record h3 { 
            margin-top: 0; 
            margin-bottom: 15px; 
            font-size: 1.3em; 
            font-weight: 600; 
            color: var(--primary-color); 
            text-align: left; 
            border-bottom: 1px solid #eee; 
            padding-bottom: 10px;
            position: relative;
            z-index: 1;
        }
        
        body.dark-mode .profile-test-record h3 {
            border-bottom: 1px solid #334155;
        }
        
        .profile-test-record .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); 
            gap: 15px; 
            text-align: center;
            position: relative;
            z-index: 1;
        }
        
        .profile-test-record .stat-value { 
            font-size: 1.8em; 
            font-weight: 700;
            display: block; 
            color: #1f2937;
        }
        
        body.dark-mode .profile-test-record .stat-value {
            color: #e2e8f0;
        }
        
        .profile-test-record .stat-label { 
            font-size: 0.8em; 
            text-transform: uppercase; 
            color: #6b7280;
        }
        
        body.dark-mode .profile-test-record .stat-label {
            color: #94a3b8;
        }
        
        /* Result Screen CSS */
        #result-summary {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin: 30px 0;
            text-align: center;
        }
        
        #result-summary .result-stat {
            flex-grow: 1;
            min-width: 100px;
            padding: 20px;
            border-radius: 16px;
            background-color: var(--bg-secondary);
            transform-style: preserve-3d;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        body.dark-mode #result-summary .result-stat {
            background-color: var(--dark-secondary);
        }
        
        #result-summary .result-stat::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-1);
            opacity: 0.1;
            z-index: 0;
            transform: translateZ(-10px);
        }
        
        #result-summary .result-stat:hover {
            transform: translateY(-5px) translateZ(10px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        #result-summary .stat-value {
            font-size: 2em;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            position: relative;
            z-index: 1;
        }
        
        #result-summary .stat-label {
            font-size: 0.9em;
            color: #6b7280;
            position: relative;
            z-index: 1;
        }
        
        body.dark-mode #result-summary .stat-label {
            color: #94a3b8;
        }
        
        /* Form Styles */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 500;
            color: #4b5563;
        }
        
        body.dark-mode .form-group label {
            color: #cbd5e1;
        }
        
        .form-group input { 
            width: 100%; 
            padding: 12px; 
            font-size: 1em; 
            border: 1px solid #d1d5db; 
            border-radius: 8px; 
            box-sizing: border-box;
            background-color: var(--card-bg);
            color: var(--text-color);
            transform-style: preserve-3d;
            transition: all 0.3s ease;
        }
        
        body.dark-mode .form-group input {
            border-color: #475569;
            background-color: var(--dark-secondary);
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
            transform: translateY(-2px) translateZ(5px);
        }
        
        .error-message { 
            color: var(--incorrect-color); 
            text-align: center; 
            margin-top: 15px;
        }
        
        .form-switch-link { 
            text-align: center; 
            margin-top: 25px; 
            font-size: 1em; 
            color: #6b7280;
        }
        
        body.dark-mode .form-switch-link {
            color: #94a3b8;
        }
        
        .form-switch-link a { 
            color: var(--primary-color); 
            font-weight: 600; 
            text-decoration: none; 
            cursor: pointer;
        }
        
        .form-switch-link a:hover { 
            text-decoration: underline;
        }
        
        /* Custom Text Screen Specific Styles */
        #custom-text-input {
            width: 100%;
            box-sizing: border-box;
            padding: 15px;
            font-size: 1em;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            margin-bottom: 20px;
            font-family: inherit;
            background-color: var(--card-bg);
            color: var(--text-color);
            transform-style: preserve-3d;
            transition: all 0.3s ease;
        }
        
        body.dark-mode #custom-text-input {
            border-color: #475569;
            background-color: var(--dark-secondary);
        }
        
        #custom-text-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
            transform: translateY(-2px) translateZ(5px);
        }
        
        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        body.dark-mode .loading-overlay {
            background: rgba(15, 23, 42, 0.8);
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s ease infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Heatmap Feature Styles */
        #heatmap-screen {
            background-color: var(--card-bg);
            padding: 40px;
            border-radius: 24px;
            box-shadow: var(--card-shadow);
            max-width: 800px;
            margin: 20px auto;
            transform-style: preserve-3d;
            transition: all 0.5s ease;
        }
        
        #heatmap-screen h2 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-align: center;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        #heatmap-screen p {
            font-size: 1.1em;
            color: #6b7280;
            margin-bottom: 30px;
            text-align: center;
        }
        
        body.dark-mode #heatmap-screen p {
            color: #94a3b8;
        }
        
        .keyboard-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
        }
        
        .keyboard-row {
            display: flex;
            margin-bottom: 10px;
            transform-style: preserve-3d;
            transition: all 0.3s ease;
        }
        
        .keyboard-row:hover {
            transform: translateY(-3px) translateZ(10px);
        }
        
        .key {
            width: 40px;
            height: 40px;
            margin: 3px;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 600;
            font-size: 0.9em;
            color: white;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            transform-style: preserve-3d;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .key::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transform: translateZ(-10px);
            transition: all 0.3s ease;
        }
        
        .key:hover {
            transform: translateY(-3px) translateZ(10px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .key.space {
            width: 300px;
        }
        
        .key.heatmap-high {
            background: var(--heatmap-high);
        }
        
        .key.heatmap-medium {
            background: var(--heatmap-medium);
        }
        
        .key.heatmap-low {
            background: var(--heatmap-low);
        }
        
        .key.heatmap-good {
            background: var(--heatmap-good);
        }
        
        .key.heatmap-none {
            background: #9ca3af;
        }
        
        body.dark-mode .key.heatmap-none {
            background: #475569;
        }
        
        .heatmap-legend {
            display: flex;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 0 10px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 8px;
        }
        
        .legend-text {
            font-size: 0.9em;
            color: #4b5563;
        }
        
        body.dark-mode .legend-text {
            color: #cbd5e1;
        }
        
        .heatmap-stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin: 30px 0;
        }
        
        .heatmap-stat {
            background-color: var(--bg-secondary);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            min-width: 120px;
            transform-style: preserve-3d;
            transition: all 0.3s ease;
        }
        
        body.dark-mode .heatmap-stat {
            background-color: var(--dark-secondary);
        }
        
        .heatmap-stat:hover {
            transform: translateY(-5px) translateZ(10px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .heatmap-stat-value {
            font-size: 1.8em;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .heatmap-stat-label {
            font-size: 0.9em;
            color: #6b7280;
            margin-top: 5px;
        }
        
        body.dark-mode .heatmap-stat-label {
            color: #94a3b8;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            header { flex-direction: column; gap: 10px; padding: 15px; }
            .card { padding: 20px; }
            .card h1, .card h2 { font-size: 1.8em; }
            .hero-stats { gap: 20px; }
            .hero-stat .stat-value { font-size: 2em; }
            #typing-area { font-size: 1.2em; max-height: 120px; }
            #stats { flex-wrap: wrap; gap: 15px; }
            .stat-value { font-size: 1.5em; }
            header nav a { padding: 8px 10px; gap: 5px; }
            header nav .nav-text { display: none; }
            .key {
                width: 30px;
                height: 30px;
                font-size: 0.8em;
            }
            .key.space {
                width: 200px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo-container">
            <h1 class="logo">TypingPro</h1>
            <p class="subtitle">Power by ATIK APP STUDIO</p>
        </div>
        <nav>
            <div id="guest-nav">
                <a href="#" id="login-nav-btn"><i class="fas fa-sign-in-alt"></i><span class="nav-text">Login</span></a>
                <a href="#" id="register-nav-btn"><i class="fas fa-user-plus"></i><span class="nav-text">Register</span></a>
            </div>
            <div id="user-nav" class="hidden">
                <a href="#" id="home-link"><i class="fas fa-home"></i><span class="nav-text">Home</span></a>
                <a href="#" id="heatmap-link"><i class="fas fa-fire"></i><span class="nav-text">Heatmap</span></a>
                <a href="#" id="profile-link"><i class="fas fa-user-cog"></i><span class="nav-text">Profile</span></a>
                <a href="#" id="leaderboard-link"><i class="fas fa-trophy"></i><span class="nav-text">Leaderboard</span></a>
                <a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i><span class="nav-text">Logout</span></a>
            </div>
        </nav>
    </header>
    <main class="container">
        <section id="home-screen" class="card">
             <h1>Master Your Keystrokes</h1>
             <p>Select a test below or use your own text to practice.</p>
             <div class="hero-stats">
                 <div class="hero-stat">
                     <div class="stat-value" id="home-best-wpm">--</div>
                     <div class="stat-label">Best WPM</div>
                 </div>
                 <div class="hero-stat">
                     <div class="stat-value" id="home-tests-taken">--</div>
                     <div class="stat-label">Tests Taken</div>
                 </div>
             </div>
             <div class="presets-section">
                <h3 class="presets-title">Choose a Test Preset</h3>
                 <div class="preset-group">
                    <h4>Custom Text</h4>
                    <div class="preset-buttons">
                        <button id="custom-text-btn" class="btn btn-primary">Practice with Custom Text</button>
                    </div>
                </div>
                <div id="quick-start-buttons">
                    <div class="preset-group">
                        <h4>Time Tests</h4>
                        <div class="preset-buttons">
                            <select id="time-test-dropdown" class="btn btn-secondary" style="width: auto;">
                                <option value="" disabled selected>Select a duration...</option>
                                <option value="15">15 Seconds</option>
                                <option value="30">30 Seconds</option>
                                <option value="60">1 Minute</option>
                                <option value="120">2 Minutes</option>
                                <option value="180">3 Minutes</option>
                                <option value="300">5 Minutes</option>
                                <option value="600">10 Minutes</option>
                                <option value="900">15 Minutes</option>
                                <option value="1200">20 Minutes</option>
                            </select>
                        </div>
                    </div>
                    <div class="preset-group">
                        <h4>Words</h4>
                        <div class="preset-buttons">
                            <button class="btn btn-secondary" data-mode="words" data-count="50">50 words</button>
                        </div>
                    </div>
                </div>
             </div>
        </section>
        
        <section id="custom-text-screen" class="hidden card">
            <h2>Custom Text Practice</h2>
            <p>Paste your text below (minimum 20 characters) and start typing!</p>
            <textarea id="custom-text-input" rows="8" placeholder="Paste your text here..."></textarea>
            <div style="text-align: center;">
                <button id="start-custom-test-btn" class="btn btn-primary">Start Custom Test</button>
                <button id="custom-back-home-btn" class="btn btn-secondary">Back to Home</button>
            </div>
        </section>
        <section id="typing-test-screen" class="hidden">
            <div id="stats">
                <div class="stat"><div id="wpm" class="stat-value">0</div><div class="stat-label">WPM</div></div>
                <div class="stat"><div id="cpm" class="stat-value">0</div><div class="stat-label">CPM</div></div>
                <div class="stat"><div id="accuracy" class="stat-value">100</div><div class="stat-label">Accuracy</div></div>
                <div class="stat"><div id="timer" class="stat-value">0</div><div class="stat-label">Time</div></div>
                <div class="stat">
                    <button id="restart-test-btn" title="Restart Test"><i class="fas fa-redo"></i></button>
                </div>
            </div>
            <div id="typing-area">
                <div id="text-to-type"></div>
            </div>
            <textarea id="text-input" rows="1" spellcheck="false" autocorrect="off" autocapitalize="off"></textarea>
            <div style="text-align: center; margin-top: 20px;">
                <button id="end-test-btn" class="btn btn-primary">End Test</button>
            </div>
        </section>
        <section id="result-screen" class="hidden card">
            <h2>Test Results</h2>
            <div id="result-summary"></div>
            <button id="retry-btn" class="btn btn-primary">Try Again</button>
            <button id="view-heatmap-btn" class="btn btn-secondary">View Heatmap</button>
            <button id="home-btn" class="btn">Go Home</button>
        </section>
        
        <section id="heatmap-screen" class="hidden card">
            <h2>Typing Heatmap</h2>
            <p>Visualize your typing patterns and identify keys you struggle with.</p>
            
            <div class="heatmap-stats">
                <div class="heatmap-stat">
                    <div class="heatmap-stat-value" id="total-keystrokes">0</div>
                    <div class="heatmap-stat-label">Total Keystrokes</div>
                </div>
                <div class="heatmap-stat">
                    <div class="heatmap-stat-value" id="accuracy-rate">0%</div>
                    <div class="heatmap-stat-label">Accuracy Rate</div>
                </div>
                <div class="heatmap-stat">
                    <div class="heatmap-stat-value" id="problem-keys">0</div>
                    <div class="heatmap-stat-label">Problem Keys</div>
                </div>
            </div>
            
            <div class="keyboard-container">
                <div class="keyboard-row">
                    <div class="key" data-key="`">`</div>
                    <div class="key" data-key="1">1</div>
                    <div class="key" data-key="2">2</div>
                    <div class="key" data-key="3">3</div>
                    <div class="key" data-key="4">4</div>
                    <div class="key" data-key="5">5</div>
                    <div class="key" data-key="6">6</div>
                    <div class="key" data-key="7">7</div>
                    <div class="key" data-key="8">8</div>
                    <div class="key" data-key="9">9</div>
                    <div class="key" data-key="0">0</div>
                    <div class="key" data-key="-">-</div>
                    <div class="key" data-key="=">=</div>
                    <div class="key" data-key="Backspace">âŒ«</div>
                </div>
                <div class="keyboard-row">
                    <div class="key" data-key="Tab">Tab</div>
                    <div class="key" data-key="q">Q</div>
                    <div class="key" data-key="w">W</div>
                    <div class="key" data-key="e">E</div>
                    <div class="key" data-key="r">R</div>
                    <div class="key" data-key="t">T</div>
                    <div class="key" data-key="y">Y</div>
                    <div class="key" data-key="u">U</div>
                    <div class="key" data-key="i">I</div>
                    <div class="key" data-key="o">O</div>
                    <div class="key" data-key="p">P</div>
                    <div class="key" data-key="[">[</div>
                    <div class="key" data-key="]">]</div>
                    <div class="key" data-key="\">\</div>
                </div>
                <div class="keyboard-row">
                    <div class="key" data-key="CapsLock">Caps</div>
                    <div class="key" data-key="a">A</div>
                    <div class="key" data-key="s">S</div>
                    <div class="key" data-key="d">D</div>
                    <div class="key" data-key="f">F</div>
                    <div class="key" data-key="g">G</div>
                    <div class="key" data-key="h">H</div>
                    <div class="key" data-key="j">J</div>
                    <div class="key" data-key="k">K</div>
                    <div class="key" data-key="l">L</div>
                    <div class="key" data-key=";">;</div>
                    <div class="key" data-key="'">'</div>
                    <div class="key" data-key="Enter">Enter</div>
                </div>
                <div class="keyboard-row">
                    <div class="key" data-key="Shift">Shift</div>
                    <div class="key" data-key="z">Z</div>
                    <div class="key" data-key="x">X</div>
                    <div class="key" data-key="c">C</div>
                    <div class="key" data-key="v">V</div>
                    <div class="key" data-key="b">B</div>
                    <div class="key" data-key="n">N</div>
                    <div class="key" data-key="m">M</div>
                    <div class="key" data-key=",">,</div>
                    <div class="key" data-key=".">.</div>
                    <div class="key" data-key="/">/</div>
                    <div class="key" data-key="Shift">Shift</div>
                </div>
                <div class="keyboard-row">
                    <div class="key" data-key="Control">Ctrl</div>
                    <div class="key" data-key="Alt">Alt</div>
                    <div class="key space" data-key=" ">Space</div>
                    <div class="key" data-key="Alt">Alt</div>
                    <div class="key" data-key="Control">Ctrl</div>
                </div>
            </div>
            
            <div class="heatmap-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--heatmap-high);"></div>
                    <div class="legend-text">High Error Rate</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--heatmap-medium);"></div>
                    <div class="legend-text">Medium Error Rate</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--heatmap-low);"></div>
                    <div class="legend-text">Low Error Rate</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--heatmap-good);"></div>
                    <div class="legend-text">Good Accuracy</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--card-shadow);"></div>
                    <div class="legend-text">No Data</div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button id="heatmap-back-home-btn" class="btn btn-secondary">Go Home</button>
            </div>
        </section>
        
        <section id="login-screen" class="hidden card">
            <h2>Login</h2>
            <form id="login-form">
                <div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" required></div>
                <div class="form-group"><label for="login-password">Password</label><input type="password" id="login-password" required></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
                <p id="login-error" class="error-message hidden"></p>
                <p class="form-switch-link">Don't have an account? <a id="go-to-register">Register</a></p>
            </form>
        </section>
        <section id="register-screen" class="hidden card">
            <h2>Register</h2>
            <form id="register-form">
                <div class="form-group"><label for="register-email">Email</label><input type="email" id="register-email" required></div>
                <div class="form-group"><label for="register-password">Password</label><input type="password" id="register-password" required></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Register</button>
                <p id="register-error" class="error-message hidden"></p>
                <p class="form-switch-link">Already have an account? <a id="go-to-login">Login</a></p>
            </form>
        </section>
        <section id="leaderboard-screen" class="hidden card">
            <h2>Leaderboards</h2>
            <p>See who is the fastest for each test duration.</p>
            
            <div class="leaderboard-tabs" id="leaderboard-tabs">
                <button class="btn-secondary active" data-mode="time" data-duration="15">15s</button>
                <button class="btn-secondary" data-mode="time" data-duration="30">30s</button>
                <button class="btn-secondary" data-mode="time" data-duration="60">1 min</button>
                <button class="btn-secondary" data-mode="time" data-duration="120">2 min</button>
                <button class="btn-secondary" data-mode="time" data-duration="180">3 min</button>
                <button class="btn-secondary" data-mode="time" data-duration="300">5 min</button>
                <button class="btn-secondary" data-mode="time" data-duration="600">10 min</button>
                <button class="btn-secondary" data-mode="time" data-duration="900">15 min</button>
                <button class="btn-secondary" data-mode="time" data-duration="1200">20 min</button>
            </div>
            <div id="leaderboard-content">
                <h3 id="leaderboard-title">Top 3 Typists</h3>
                <ol id="leaderboard-list"></ol>
            </div>
        </section>
        <section id="profile-screen" class="hidden card">
            <h2>My Profile</h2>
            <p id="profile-email">user@example.com</p>
            <div id="profile-stats-container"></div>
            <button id="profile-back-home-btn" class="btn btn-secondary">Go Home</button>
        </section>
    </main>
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="spinner"></div>
    </div>
    <button id="dark-mode-toggle" class="dark-mode-toggle">
        <i class="fas fa-moon"></i>
    </button>
    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDZrP8uuHQOSlU5rnQqmJ-_mKYs6GaO_AA",
            authDomain: "all-app-er.firebaseapp.com",
            databaseURL: "https://all-app-er-default-rtdb.firebaseio.com",
            projectId: "all-app-er",
            storageBucket: "all-app-er.appspot.com",
            messagingSenderId: "166378015396",
            appId: "1:166378015396:web:48cfb3cfa81611d7627431"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        // --- Paragraphs for Typing Test ---
        const textPool = [
            "The quick brown fox jumps over the lazy dog. This sentence contains every letter of the alphabet.",
            "A journey of a thousand miles begins with a single step. Lao Tzu said this to emphasize that great things start with small beginnings.",
            "To be or not to be that is the question. A famous line from William Shakespeare's play Hamlet.",
            "The internet has revolutionized the way we live, work, and communicate. It connects billions of people worldwide.",
            "Artificial intelligence is no longer the realm of science fiction; it is an integral part of our daily lives.",
            "Cloud computing has fundamentally changed the information technology landscape by offering scalability and flexibility.",
            "The early bird catches the worm. This proverb suggests that starting something early gives you a better chance of success.",
            "Actions speak louder than words. It is more important what you do than what you say.",
            "Honesty is the best policy. It is always better to tell the truth, even when it is difficult.",
            "Practice makes perfect. The more you do something, the better you will become at it.",
            "Where there is a will there is a way. If you are determined enough, you can find a way to achieve what you want."
        ];
        
        let endlessModeTextPool = [];
        // --- DOM Elements & State ---
        const allScreens = document.querySelectorAll('main > section');
        const textToType = document.getElementById('text-to-type');
        const textInput = document.getElementById('text-input');
        const loadingOverlay = document.getElementById('loading-overlay');
        const timeTestDropdown = document.getElementById('time-test-dropdown');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        let currentScreenId = 'home-screen';
        let timerInterval, testActive, startTime, lastTestConfig = {}, mistakes, typedChars;
        let keyStats = {}; // Object to store key statistics for heatmap
        let currentTestKeyStats = {}; // Key stats for current test
        
        // Check for saved dark mode preference
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        }
        
        // --- START: Navigation and History Management ---
        function showScreen(screenId, pushState = true) {
            if (!document.getElementById(screenId)) {
                console.error("Screen not found:", screenId);
                return;
            }
            allScreens.forEach(screen => screen.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            currentScreenId = screenId;
            if (pushState) {
                const newPath = (screenId === 'home-screen') ? window.location.pathname : `#${screenId}`;
                history.pushState({ screen: screenId }, '', newPath);
            }
            updateActiveNav(screenId);
        }
        
        function updateActiveNav(screenId) {
            document.querySelectorAll('#user-nav a').forEach(link => link.classList.remove('nav-active'));
            let activeLink;
            switch(screenId) {
                case 'home-screen': case 'custom-text-screen': case 'typing-test-screen': case 'result-screen':
                    activeLink = document.getElementById('home-link'); break;
                case 'profile-screen': activeLink = document.getElementById('profile-link'); break;
                case 'leaderboard-screen': activeLink = document.getElementById('leaderboard-link'); break;
                case 'heatmap-screen': activeLink = document.getElementById('heatmap-link'); break;
            }
            if (activeLink) activeLink.classList.add('nav-active');
        }
        
        window.addEventListener('popstate', (event) => {
            const targetScreen = (event.state && event.state.screen) || 'home-screen';
            showScreen(targetScreen, false);
        });
        
        function navigateHome() { showScreen('home-screen', true); }
        // --- END: Navigation and History Management ---
        
        function showLoading() { loadingOverlay.classList.remove('hidden'); }
        function hideLoading() { loadingOverlay.classList.add('hidden'); }
        
        function generateMoreText() {
            if (endlessModeTextPool.length === 0) {
                endlessModeTextPool = shuffleArray([...textPool]);
            }
            const newText = endlessModeTextPool.shift();
            const spaceSpan = document.createElement('span');
            spaceSpan.innerText = ' ';
            textToType.appendChild(spaceSpan);
            newText.split('').forEach(char => {
                const span = document.createElement('span');
                span.innerText = char;
                textToType.appendChild(span);
            });
        }
        
        function restartTest() {
            if (!testActive) return;
            clearInterval(timerInterval);
            startTest(lastTestConfig.mode, lastTestConfig.value, lastTestConfig.customText);
        }
        
        function shuffleArray(arr) { return [...arr].sort(() => Math.random() - 0.5); }
        
        function setupTextForTest(text) {
            textToType.innerHTML = '';
            text.split('').forEach(char => {
                const span = document.createElement('span');
                span.innerText = char;
                textToType.appendChild(span);
            });
        }
        
        function startTest(mode, value, customText = null) {
            lastTestConfig = { mode, value, customText };
            testActive = true;
            startTime = null;
            mistakes = 0;
            typedChars = 0;
            currentTestKeyStats = {}; // Reset key stats for this test
            textInput.value = '';
            textInput.disabled = false;
            
            let textToUse;
            if (customText) {
                textToUse = customText;
            } else if (mode === 'time') {
                endlessModeTextPool = shuffleArray([...textPool]);
                textToUse = endlessModeTextPool.shift();
            } else if (mode === 'words') {
                const allWords = textPool.join(' ').split(/\s+/).filter(Boolean);
                const shuffledWords = shuffleArray(allWords);
                textToUse = shuffledWords.slice(0, value).join(' ');
            }
            setupTextForTest(textToUse);
            showScreen('typing-test-screen');
            textInput.focus();
            
            let timerLabel = "0";
            if (mode === 'time') timerLabel = value;
            document.getElementById('timer').innerText = timerLabel;
            
            updateCursor();
            resetLiveStats();
        }
        
        function endTest() {
            if (!testActive) return;
            testActive = false;
            clearInterval(timerInterval);
            textInput.disabled = true;
            const results = calculateFinalStats();
            displayResults(results);
            saveResultsToFirebase(results, lastTestConfig);
            showScreen('result-screen');
            
            // Reset dropdown to default after test is finished
            timeTestDropdown.value = ""; 
        }
        
        function calculateFinalStats() {
            if (!startTime) return { wpm: 0, cpm: 0, accuracy: 100, mistakes: 0 };
            const timeElapsedSeconds = (new Date().getTime() - startTime) / 1000;
            const correctChars = typedChars - mistakes;
            const wpm = timeElapsedSeconds > 0 ? Math.round((correctChars / 5) / (timeElapsedSeconds / 60)) : 0;
            const cpm = timeElapsedSeconds > 0 ? Math.round(correctChars / (timeElapsedSeconds / 60)) : 0;
            const accuracy = typedChars > 0 ? Math.round((correctChars / typedChars) * 100) : 100;
            return { wpm, cpm, accuracy: Math.max(0, accuracy), mistakes };
        }
        
        function displayResults({ wpm, cpm, accuracy, mistakes }) {
            const resultSummary = document.getElementById('result-summary');
            resultSummary.innerHTML = `
                <div class="result-stat"><div class="stat-value">${wpm}</div><div class="stat-label">WPM</div></div>
                <div class="result-stat"><div class="stat-value">${cpm}</div><div class="stat-label">CPM</div></div>
                <div class="result-stat"><div class="stat-value">${accuracy}%</div><div class="stat-label">Accuracy</div></div>
                <div class="result-stat"><div class="stat-value">${mistakes}</div><div class="stat-label">Mistakes</div></div>`;
        }
        
        function updateLiveStats() {
            if (!startTime) return;
            const stats = calculateFinalStats();
            document.getElementById('wpm').innerText = stats.wpm;
            document.getElementById('cpm').innerText = stats.cpm;
            document.getElementById('accuracy').innerText = stats.accuracy;
        }
        
        function resetLiveStats() {
            document.getElementById('wpm').innerText = 0;
            document.getElementById('cpm').innerText = 0;
            document.getElementById('accuracy').innerText = 100;
        }
        
        function updateCursor() {
            const textSpans = textToType.querySelectorAll('span');
            textSpans.forEach(span => span.classList.remove('current'));
            const currentPos = textInput.value.length;
            if (currentPos < textSpans.length) {
                const cursorSpan = textSpans[currentPos];
                cursorSpan.classList.add('current');
                cursorSpan.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
        
        // --- Firebase & Auth Logic ---
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('guest-nav').classList.add('hidden');
                document.getElementById('user-nav').classList.remove('hidden');
                fetchUserStats(user.uid);
                fetchKeyStats(user.uid);
            } else {
                document.getElementById('guest-nav').classList.remove('hidden');
                document.getElementById('user-nav').classList.add('hidden');
                document.getElementById('home-best-wpm').innerText = '--';
                document.getElementById('home-tests-taken').innerText = '--';
            }
            if (currentScreenId !== 'home-screen' && !user) {
                 showScreen('home-screen', false);
                 history.replaceState({screen: 'home-screen'}, '', window.location.pathname);
            }
            updateActiveNav(currentScreenId);
        });
        
        function fetchUserStats(uid) {
            db.ref(`users/${uid}`).once('value', snapshot => {
                if (snapshot.exists()) {
                    const stats = snapshot.val();
                    document.getElementById('home-best-wpm').innerText = stats.overallBestWpm || 0;
                    document.getElementById('home-tests-taken').innerText = stats.testsTaken || 0;
                }
            });
        }
        
        function fetchKeyStats(uid) {
            db.ref(`keyStats/${uid}`).once('value', snapshot => {
                if (snapshot.exists()) {
                    keyStats = snapshot.val();
                } else {
                    keyStats = {};
                }
            });
        }
        
        function saveKeyStatsToFirebase(uid) {
            if (!uid || Object.keys(currentTestKeyStats).length === 0) return;
            
            // Merge current test stats with existing stats
            Object.keys(currentTestKeyStats).forEach(key => {
                if (!keyStats[key]) {
                    keyStats[key] = {
                        correct: 0,
                        incorrect: 0,
                        total: 0
                    };
                }
                
                keyStats[key].correct += currentTestKeyStats[key].correct || 0;
                keyStats[key].incorrect += currentTestKeyStats[key].incorrect || 0;
                keyStats[key].total += currentTestKeyStats[key].total || 0;
            });
            
            // Save to Firebase
            db.ref(`keyStats/${uid}`).set(keyStats);
        }
        
        async function saveResultsToFirebase(results, { mode, value }) {
            const user = auth.currentUser;
            if (!user || results.wpm === 0 || !mode || !value || mode === 'custom') return;
            
            // Save key stats
            saveKeyStatsToFirebase(user.uid);
            
            const testKey = `${mode}_${value}`;
            const userStatsRef = db.ref(`users/${user.uid}`);
            const leaderboardRef = db.ref(`testLeaderboards/${testKey}`);
            
            try {
                // Update user's personal stats
                const snapshot = await userStatsRef.once('value');
                const stats = snapshot.val() || { email: user.email, testsTaken: 0, overallBestWpm: 0, scores: {} };
                const currentBestForTest = (stats.scores && stats.scores[testKey]) ? stats.scores[testKey] : { wpm: 0 };
                
                if (results.wpm > currentBestForTest.wpm) {
                    if (!stats.scores) stats.scores = {};
                    stats.scores[testKey] = results;
                }
                
                const newOverallBest = Math.max(stats.overallBestWpm || 0, results.wpm);
                const updates = {
                    testsTaken: (stats.testsTaken || 0) + 1,
                    overallBestWpm: newOverallBest,
                    scores: stats.scores,
                    email: user.email
                };
                await userStatsRef.update(updates);
                
                // Update the test-specific leaderboard
                const leaderboardSnapshot = await leaderboardRef.orderByChild('wpm').once('value');
                const scores = [];
                leaderboardSnapshot.forEach(child => {
                    scores.push({
                        ...child.val(),
                        key: child.key
                    });
                });
                const userExistingScore = scores.find(score => score.userId === user.uid);
                
                if (userExistingScore) {
                    if (results.wpm > userExistingScore.wpm) {
                        await leaderboardRef.child(userExistingScore.key).update({
                            wpm: results.wpm,
                            accuracy: results.accuracy,
                        });
                    }
                } else {
                    await leaderboardRef.push({
                        email: user.email,
                        wpm: results.wpm,
                        accuracy: results.accuracy,
                        userId: user.uid
                    });
                }
                
                // Trim leaderboard to top 3
                const finalLeaderboardSnapshot = await leaderboardRef.orderByChild('wpm').once('value');
                const finalScores = [];
                finalLeaderboardSnapshot.forEach(child => {
                    finalScores.push({
                        ...child.val(),
                        key: child.key
                    });
                });
                
                finalScores.sort((a, b) => b.wpm - a.wpm);
                
                if (finalScores.length > 3) {
                    for (let i = 3; i < finalScores.length; i++) {
                        await leaderboardRef.child(finalScores[i].key).remove();
                    }
                }
                
                fetchUserStats(user.uid);
            } catch (error) {
                console.error("Error saving results: ", error);
            }
        }
        
        function showLeaderboardScreen() {
            showScreen('leaderboard-screen');
            const firstButton = document.querySelector('#leaderboard-tabs button');
            if (firstButton) {
                firstButton.click();
            }
        }
        
        async function displayLeaderboardForTest(mode, duration) {
            const testKey = `${mode}_${duration}`;
            const leaderboardList = document.getElementById('leaderboard-list');
            const leaderboardTitle = document.getElementById('leaderboard-title');
            
            let titleText;
            if (duration < 60) {
                titleText = `Top Typists for ${duration} Seconds`;
            } else {
                const minutes = duration / 60;
                titleText = `Top Typists for ${minutes} Minute${minutes > 1 ? 's' : ''}`;
            }
            leaderboardTitle.innerText = titleText;
            leaderboardList.innerHTML = '<li>Loading...</li>';
            try {
                const leaderboardRef = db.ref(`testLeaderboards/${testKey}`).orderByChild('wpm');
                const snapshot = await leaderboardRef.once('value');
                
                if (snapshot.exists()) {
                    const scoresArray = [];
                    snapshot.forEach(child => {
                        scoresArray.push(child.val());
                    });
                    
                    const sortedScores = scoresArray.sort((a, b) => b.wpm - a.wpm).slice(0, 3);
                    
                    const medals = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'];
                    leaderboardList.innerHTML = sortedScores.map((score, index) =>
                        `<li>
                            <span class="rank">${medals[index] || (index + 1) + '.'}</span>
                            <span class="email">${score.email}</span>
                            <span class="wpm">${score.wpm} WPM</span>
                        </li>`
                    ).join('');
                } else { 
                    leaderboardList.innerHTML = '<li>No scores yet for this category. Be the first!</li>'; 
                }
            } catch (error) {
                console.error(`Failed to load leaderboard for ${testKey}:`, error);
                leaderboardList.innerHTML = '<li>Could not load scores. Please try again later.</li>';
            }
        }
        
        async function showProfileScreen() {
            const user = auth.currentUser;
            if (!user) { showScreen('login-screen'); return; }
            showScreen('profile-screen');
            const profileContainer = document.getElementById('profile-stats-container');
            document.getElementById('profile-email').innerText = user.email;
            profileContainer.innerHTML = '<p>Loading your best scores...</p>';
            const createLabelFromKey = (key) => {
                const [type, value] = key.split('_');
                if (type === 'time') {
                    const seconds = parseInt(value, 10);
                    return seconds >= 60 ? `${seconds / 60} Minute${seconds > 60 ? 's' : ''} Best` : `${seconds} Second${seconds > 1 ? 's' : ''} Best`;
                }
                return type === 'words' ? `${value} Word${parseInt(value, 10) > 1 ? 's' : ''} Best` : key;
            };
            try {
                const snapshot = await db.ref(`users/${user.uid}/scores`).once('value');
                const scores = snapshot.val() || {};
                const scoreKeys = Object.keys(scores);
                let profileHtml = '';
                if (scoreKeys.length === 0) {
                     profileHtml = '<p>You have not completed any tests yet. Go take one!</p>';
                } else {
                    scoreKeys.sort((a, b) => {
                        const [typeA, valA] = a.split('_');
                        const [typeB, valB] = b.split('_');
                        if (typeA !== typeB) return typeA.localeCompare(typeB);
                        return parseInt(valA, 10) - parseInt(valB, 10);
                    }).forEach(key => {
                        const scoreData = scores[key];
                        if (scoreData) {
                            profileHtml += `
                                <div class="profile-test-record">
                                    <h3>${createLabelFromKey(key)}</h3>
                                    <div class="stats-grid">
                                        <div><span class="stat-value">${scoreData.wpm}</span><span class="stat-label">WPM</span></div>
                                        <div><span class="stat-value">${scoreData.cpm}</span><span class="stat-label">CPM</span></div>
                                        <div><span class="stat-value">${scoreData.accuracy}%</span><span class="stat-label">Accuracy</span></div>
                                        <div><span class="stat-value">${scoreData.mistakes}</span><span class="stat-label">Mistakes</span></div>
                                    </div>
                                </div>`;
                        }
                    });
                }
                profileContainer.innerHTML = profileHtml || '<p>You have not completed any tests yet. Go take one!</p>';
            } catch (error) {
                console.error("Could not load profile stats:", error);
                profileContainer.innerHTML = '<p>Could not load your stats. Please try again.</p>';
            }
        }
        
        function showHeatmapScreen() {
            const user = auth.currentUser;
            if (!user) { 
                showScreen('login-screen'); 
                return; 
            }
            
            showScreen('heatmap-screen');
            updateHeatmap();
        }
        
        function updateHeatmap() {
            // Calculate heatmap statistics
            let totalKeystrokes = 0;
            let totalMistakes = 0;
            let problemKeysCount = 0;
            
            // Update each key on the heatmap
            document.querySelectorAll('.key').forEach(keyElement => {
                const keyValue = keyElement.getAttribute('data-key');
                
                // Remove all heatmap classes
                keyElement.classList.remove('heatmap-high', 'heatmap-medium', 'heatmap-low', 'heatmap-good', 'heatmap-none');
                
                if (keyStats[keyValue] && keyStats[keyValue].total > 0) {
                    const accuracy = keyStats[keyValue].correct / keyStats[keyValue].total;
                    totalKeystrokes += keyStats[keyValue].total;
                    totalMistakes += keyStats[keyValue].incorrect;
                    
                    if (accuracy < 0.7) {
                        keyElement.classList.add('heatmap-high');
                        problemKeysCount++;
                    } else if (accuracy < 0.85) {
                        keyElement.classList.add('heatmap-medium');
                        problemKeysCount++;
                    } else if (accuracy < 0.95) {
                        keyElement.classList.add('heatmap-low');
                    } else {
                        keyElement.classList.add('heatmap-good');
                    }
                } else {
                    keyElement.classList.add('heatmap-none');
                }
            });
            
            // Update heatmap statistics
            document.getElementById('total-keystrokes').innerText = totalKeystrokes;
            document.getElementById('accuracy-rate').innerText = totalKeystrokes > 0 ? 
                Math.round((1 - totalMistakes / totalKeystrokes) * 100) + '%' : '0%';
            document.getElementById('problem-keys').innerText = problemKeysCount;
        }
        
        // --- Event Listeners ---
        function preventDefault(e) { e.preventDefault(); }
        
        document.querySelector('.logo-container').addEventListener('click', (e) => { preventDefault(e); navigateHome(); });
        document.getElementById('login-nav-btn').addEventListener('click', (e) => { preventDefault(e); showScreen('login-screen'); });
        document.getElementById('register-nav-btn').addEventListener('click', (e) => { preventDefault(e); showScreen('register-screen'); });
        document.getElementById('leaderboard-link').addEventListener('click', (e) => { preventDefault(e); showLeaderboardScreen(); });
        document.getElementById('heatmap-link').addEventListener('click', (e) => { preventDefault(e); showHeatmapScreen(); });
        document.getElementById('logout-btn').addEventListener('click', (e) => { preventDefault(e); auth.signOut().then(navigateHome); });
        document.getElementById('home-link').addEventListener('click', (e) => { preventDefault(e); navigateHome(); });
        document.getElementById('home-btn').addEventListener('click', (e) => { preventDefault(e); navigateHome(); });
        document.getElementById('profile-link').addEventListener('click', (e) => { preventDefault(e); showProfileScreen(); });
        document.getElementById('profile-back-home-btn').addEventListener('click', (e) => { preventDefault(e); navigateHome(); });
        document.getElementById('heatmap-back-home-btn').addEventListener('click', (e) => { preventDefault(e); navigateHome(); });
        document.getElementById('go-to-register').addEventListener('click', (e) => { preventDefault(e); showScreen('register-screen'); });
        document.getElementById('go-to-login').addEventListener('click', (e) => { preventDefault(e); showScreen('login-screen'); });
        
        // Dark mode toggle
        darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
            darkModeToggle.innerHTML = isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        });
        
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            preventDefault(e);
            showLoading();
            const errEl = document.getElementById('login-error');
            errEl.classList.add('hidden');
            try {
                await auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value);
                navigateHome();
            } catch (err) {
                errEl.innerText = err.message;
                errEl.classList.remove('hidden');
            } finally {
                hideLoading();
            }
        });
        
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            preventDefault(e);
            showLoading();
            const errEl = document.getElementById('register-error');
            errEl.classList.add('hidden');
            try {
                await auth.createUserWithEmailAndPassword(document.getElementById('register-email').value, document.getElementById('register-password').value);
                navigateHome();
            } catch (err) {
                errEl.innerText = err.message;
                errEl.classList.remove('hidden');
            } finally {
                hideLoading();
            }
        });
        
        document.getElementById('quick-start-buttons').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.mode) {
                startTest(e.target.dataset.mode, parseInt(e.target.dataset.duration || e.target.dataset.count, 10));
            }
        });
        
        timeTestDropdown.addEventListener('change', (e) => {
            const duration = parseInt(e.target.value, 10);
            if (!isNaN(duration)) {
                startTest('time', duration);
            }
        });
        
        timeTestDropdown.addEventListener('click', (e) => {
            if (e.target.tagName === 'OPTION') {
                const duration = parseInt(e.target.value, 10);
                if (!isNaN(duration)) {
                    startTest('time', duration);
                }
            }
        });
        
        document.getElementById('custom-text-btn').addEventListener('click', () => showScreen('custom-text-screen'));
        document.getElementById('custom-back-home-btn').addEventListener('click', navigateHome);
        document.getElementById('start-custom-test-btn').addEventListener('click', () => {
            const customText = document.getElementById('custom-text-input').value.trim();
            if (customText.length >= 20) {
                startTest('custom', customText.length, customText);
            } else {
                alert('Please paste at least 20 characters of text to start.');
            }
        });
        
        document.getElementById('retry-btn').addEventListener('click', () => {
             if (lastTestConfig.mode) {
                startTest(lastTestConfig.mode, lastTestConfig.value, lastTestConfig.customText);
             } else {
                navigateHome();
             }
        });
        
        document.getElementById('view-heatmap-btn').addEventListener('click', () => {
            showHeatmapScreen();
        });
        
        document.getElementById('end-test-btn').addEventListener('click', endTest);
        document.getElementById('restart-test-btn').addEventListener('click', restartTest);
        
        document.getElementById('leaderboard-tabs').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                document.querySelectorAll('#leaderboard-tabs button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                const mode = e.target.dataset.mode;
                const duration = parseInt(e.target.dataset.duration, 10);
                displayLeaderboardForTest(mode, duration);
            }
        });
        
        textInput.addEventListener('keydown', (e) => {
            if (!testActive) return;

            const typedChar = e.key;
            const originalTextSpans = textToType.querySelectorAll('span');
            const currentPos = textInput.value.length;
            
            // For heatmap, we track keydown events
            if (typedChar.length === 1 || typedChar === ' ') {
                const originalChar = originalTextSpans[currentPos] ? originalTextSpans[currentPos].innerText : null;
                const isCorrect = originalChar && typedChar === originalChar;
                
                const key = typedChar.toLowerCase();
                if (!currentTestKeyStats[key]) {
                    currentTestKeyStats[key] = { correct: 0, incorrect: 0, total: 0 };
                }
                currentTestKeyStats[key].total++;
                if (isCorrect) {
                    currentTestKeyStats[key].correct++;
                } else {
                    currentTestKeyStats[key].incorrect++;
                }
            }
        });
        
        textInput.addEventListener('input', () => {
            if (!testActive) return;
            
            if (!startTime) {
                startTime = new Date().getTime();
                if (lastTestConfig.mode === 'time') {
                     timerInterval = setInterval(() => {
                        const timeElapsed = Math.floor((new Date().getTime() - startTime) / 1000);
                        const timeRemaining = lastTestConfig.value - timeElapsed;
                        document.getElementById('timer').innerText = Math.max(0, timeRemaining);
                        if (timeRemaining <= 0) endTest();
                    }, 1000);
                }
            }
            
            const originalTextSpans = textToType.querySelectorAll('span');
            const currentTypedText = textInput.value;
            typedChars = currentTypedText.length;
            mistakes = 0;
            
            for (let i = 0; i < currentTypedText.length; i++) {
                if (i >= originalTextSpans.length) break;
                const typedChar = currentTypedText[i];
                const originalChar = originalTextSpans[i].innerText;
                
                if (typedChar !== originalChar) {
                    mistakes++;
                    originalTextSpans[i].className = 'incorrect';
                } else {
                    originalTextSpans[i].className = 'correct';
                }
            }
            
            for (let i = typedChars; i < originalTextSpans.length; i++) {
                originalTextSpans[i].className = '';
            }
            
            if (lastTestConfig.mode === 'time' && typedChars > originalTextSpans.length - 50) {
                generateMoreText();
            }
            
            if ((lastTestConfig.mode === 'words' || lastTestConfig.mode === 'custom') && typedChars === originalTextSpans.length) {
                endTest();
            }
            
            updateCursor();
            updateLiveStats();
        });
        
        // Initial Load
        document.addEventListener('DOMContentLoaded', () => {
            const initialScreen = window.location.hash.substring(1) || 'home-screen';
            if (document.getElementById(initialScreen)) {
                showScreen(initialScreen, false);
                history.replaceState({ screen: initialScreen }, '', window.location.pathname + (initialScreen !== 'home-screen' ? `#${initialScreen}` : ''));
            } else {
                showScreen('home-screen', false);
                history.replaceState({ screen: 'home-screen' }, '', window.location.pathname);
            }
        });
    </script>
</body>
</html>

