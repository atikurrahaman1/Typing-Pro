<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing Test Pro - Advanced</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
    <style>
        :root {
            --bg-primary: transparent;
            --bg-secondary: transparent;
            --text-color: #ffffff;
            --card-bg: rgba(0, 0, 0, 0.6);
            --card-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --secondary-color: rgba(255, 255, 255, 0.1);
            --secondary-hover: rgba(255, 255, 255, 0.2);
            --correct-color: #16a34a;
            --incorrect-color: #dc2626;
            --caret-color: #3b82f6;
            --gradient-1: linear-gradient(135deg, #3b82f6, #8b5cf6);
            --gradient-2: linear-gradient(135deg, #8b5cf6, #ec4899);
            --gradient-3: linear-gradient(135deg, #ec4899, #f43f5e);
            --dark-bg: rgba(15, 23, 42, 0.1);
            --dark-card: rgba(30, 41, 59, 0.2);
            --dark-text: #e2e8f0;
            --dark-secondary: rgba(51, 65, 85, 0.3);
            --heatmap-high: #ef4444;
            --heatmap-medium: #f97316;
            --heatmap-low: #eab308;
            --heatmap-good: #22c55e;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            background: transparent;
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            position: relative;
        }
        
        /* Background Video Styles */
        .video-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        
        .video-background video {
            position: absolute;
            top: 50%;
            left: 50%;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            transform: translateX(-50%) translateY(-50%);
            object-fit: cover;
        }
        
        .video-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.2);
            z-index: -1;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            flex-grow: 1;
            position: relative;
            z-index: 1;
        }
        
        /* Header Styles */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: var(--card-bg);
            box-shadow: var(--card-shadow);
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .logo-container {
            text-align: left;
        }
        
        .logo-container .logo {
            font-family: 'Roboto Mono', monospace;
            font-size: 2.2em;
            font-weight: 700;
            cursor: pointer;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin: 0;
            line-height: 1;
        }
        
        .logo-container .subtitle {
            font-size: 0.8em;
            font-weight: 600;
            color: #cbd5e1;
            margin: 0;
            margin-top: 2px;
        }
        
        header nav {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        header nav a {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            text-decoration: none;
            color: #cbd5e1;
            font-weight: 500;
            transition: all 0.2s ease;
            border-radius: 8px;
        }
        
        header nav a:hover {
            background-color: var(--secondary-color);
        }
        
        header nav a.nav-active {
            color: var(--primary-color);
            font-weight: 700;
            background-color: var(--secondary-color);
        }
        
        header nav .fas, header nav .far {
            font-size: 1.1em;
        }
        
        /* Dark mode toggle - Hidden but kept for functionality */
        .dark-mode-toggle {
            display: none;
        }
        
        /* Utility */
        .hidden { display: none !important; }
        
        /* Button Styles */
        .btn {
            padding: 10px 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            margin: 5px;
            transition: all 0.2s ease;
            font-family: inherit;
            background-color: var(--secondary-color);
            color: #ffffff;
        }
        
        .btn:hover {
            background-color: var(--secondary-hover);
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: var(--gradient-1);
            color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .btn-primary:hover {
            background: var(--gradient-1);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            color: #ffffff;
            border-color: var(--secondary-hover);
        }
        
        .btn-secondary:hover {
            background-color: var(--secondary-hover);
        }
        
        /* Select */
        #time-test-dropdown {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%233b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 30px;
            cursor: pointer;
        }
        
        /* Card Styles */
        .card {
            background-color: var(--card-bg);
            padding: 40px;
            border-radius: 24px;
            box-shadow: var(--card-shadow);
            max-width: 800px;
            margin: 20px auto;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0) 100%);
            z-index: 0;
            pointer-events: none;
        }
        
        .card h1, .card h2 { 
            font-size: 2.5em; 
            margin-bottom: 10px; 
            text-align: center; 
            font-weight: 700;
            position: relative;
            z-index: 1;
        }
        
        .card p { 
            font-size: 1.1em; 
            color: #cbd5e1; 
            margin-bottom: 30px; 
            text-align: center;
            position: relative;
            z-index: 1;
        }
        
        /* Home Screen */
        .hero-stats { 
            display: flex; 
            justify-content: center; 
            gap: 40px; 
            margin-bottom: 30px; 
        }
        
        .hero-stat { 
            padding: 20px;
            border-radius: 16px;
            background: var(--secondary-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .hero-stat::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-1);
            opacity: 0.1;
            z-index: 0;
        }
        
        .hero-stat .stat-value { 
            font-size: 2.5em; 
            font-weight: 700;
            position: relative;
            z-index: 1;
        }
        
        .hero-stat .stat-label { 
            font-size: 1em; 
            color: #cbd5e1;
            position: relative;
            z-index: 1;
        }
        
        .presets-section { 
            margin-top: 40px; 
        }
        
        .presets-title { 
            font-size: 1.4em; 
            font-weight: 600; 
            color: #cbd5e1; 
            text-align: center; 
            margin-bottom: 20px;
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .presets-title::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 3px;
            background: var(--gradient-1);
            border-radius: 3px;
        }
        
        .preset-group { 
            margin-bottom: 25px; 
        }
        
        .preset-group h4 { 
            font-weight: 500; 
            color: #cbd5e1; 
            text-align: center; 
            margin-bottom: 10px;
        }
        
        .preset-buttons { 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 15px; 
        }
        
        /* Typing Test Area */
        #stats { 
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            margin-bottom: 20px; 
            padding: 20px; 
            background-color: var(--card-bg); 
            border-radius: 16px; 
            box-shadow: var(--card-shadow);
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat { 
            text-align: center; 
        }
        
        .stat-value { 
            font-size: 2em; 
            font-weight: bold;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .stat-label { 
            font-size: 0.8em; 
            text-transform: uppercase; 
            color: #cbd5e1;
        }
        
        #restart-test-btn {
            background: none;
            border: none;
            color: #cbd5e1;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        #restart-test-btn:hover {
            color: var(--primary-color);
        }
        
        #typing-area {
            font-family: 'Roboto Mono', monospace;
            font-size: 1.6em;
            line-height: 1.8;
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            max-height: 140px;
            overflow-y: auto;
            -webkit-mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
            mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #typing-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            border-radius: 16px;
            z-index: 0;
            pointer-events: none;
        }
        
        #text-to-type span.correct { 
            color: var(--correct-color);
            text-shadow: 0 0 5px rgba(22, 163, 74, 0.3);
        }
        
        #text-to-type span.incorrect { 
            color: var(--incorrect-color); 
            text-decoration: underline;
            text-shadow: 0 0 5px rgba(220, 38, 38, 0.3);
        }
        
        #text-to-type span.current {
            background-color: var(--caret-color);
            border-radius: 3px;
            color: white;
            padding: 2px 0;
            margin-right: -2px;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        #text-input { 
            font-family: 'Roboto Mono', monospace;
            width: 100%; 
            padding: 10px; 
            font-size: 1em; 
            border: 2px solid rgba(255, 255, 255, 0.2); 
            border-radius: 8px; 
            margin-top: 20px; 
            font-family: inherit;
            background-color: var(--card-bg);
            color: var(--text-color);
            transition: all 0.2s ease;
        }
        
        #text-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
        }
        
        /* Leaderboard Styles */
        .leaderboard-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        
        .leaderboard-tabs button {
            background-color: var(--secondary-color);
            color: #ffffff;
            border: 1px solid var(--secondary-hover);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            user-select: none;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .leaderboard-tabs button:hover {
            background-color: var(--secondary-hover);
        }
        
        .leaderboard-tabs button.active {
            background: var(--gradient-1);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }
        
        #leaderboard-content h3 {
            text-align: center;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 20px;
        }
        
        #leaderboard-list { 
            list-style-type: none; 
            padding: 0; 
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        #leaderboard-list li { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            font-size: 1.2em;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.2s ease;
            position: relative;
        }
        
        #leaderboard-list li:last-child { border-bottom: none; }
        
        #leaderboard-list li .rank { 
            font-weight: bold; 
            min-width: 40px; 
            color: var(--primary-color);
            font-size: 1.2em;
        }
        
        #leaderboard-list li .email { 
            flex-grow: 1; 
            color: #e2e8f0; 
            word-break: break-all; 
            margin: 0 15px;
        }
        
        #leaderboard-list li .wpm { 
            font-weight: 600; 
            color: var(--correct-color);
        }
        
        /* Profile Screen CSS */
        #profile-stats-container { 
            display: flex; 
            flex-direction: column; 
            gap: 25px; 
            margin-top: 20px;
        }
        
        .profile-test-record { 
            background-color: rgba(255, 255, 255, 0.05); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: 12px; 
            padding: 20px;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .profile-test-record::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-1);
            opacity: 0.05;
            z-index: 0;
        }
        
        .profile-test-record h3 { 
            margin-top: 0; 
            margin-bottom: 15px; 
            font-size: 1.3em; 
            font-weight: 600; 
            color: var(--primary-color); 
            text-align: left; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            padding-bottom: 10px;
            position: relative;
            z-index: 1;
        }
        
        .profile-test-record .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); 
            gap: 15px; 
            text-align: center;
            position: relative;
            z-index: 1;
        }
        
        .profile-test-record .stat-value { 
            font-size: 1.8em; 
            font-weight: 700;
            display: block; 
            color: #e2e8f0;
        }
        
        .profile-test-record .stat-label { 
            font-size: 0.8em; 
            text-transform: uppercase; 
            color: #cbd5e1;
        }
        
        /* Result Screen CSS */
        #result-summary {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin: 30px 0;
            text-align: center;
        }
        
        #result-summary .result-stat {
            flex-grow: 1;
            min-width: 100px;
            padding: 20px;
            border-radius: 16px;
            background-color: rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #result-summary .result-stat::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-1);
            opacity: 0.1;
            z-index: 0;
        }
        
        #result-summary .stat-value {
            font-size: 2em;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            position: relative;
            z-index: 1;
        }
        
        #result-summary .stat-label {
            font-size: 0.9em;
            color: #cbd5e1;
            position: relative;
            z-index: 1;
        }
        
        /* Form Styles */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 500;
            color: #cbd5e1;
        }
        
        .form-group input { 
            width: 100%; 
            padding: 12px; 
            font-size: 1em; 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            border-radius: 8px; 
            box-sizing: border-box;
            background-color: var(--card-bg);
            color: var(--text-color);
            transition: all 0.2s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
        }
        
        .error-message { 
            color: var(--incorrect-color); 
            text-align: center; 
            margin-top: 15px;
        }
        
        .form-switch-link { 
            text-align: center; 
            margin-top: 25px; 
            font-size: 1em; 
            color: #cbd5e1;
        }
        
        .form-switch-link a { 
            color: var(--primary-color); 
            font-weight: 600; 
            text-decoration: none; 
            cursor: pointer;
        }
        
        .form-switch-link a:hover { 
            text-decoration: underline;
        }
        
        /* Custom Text Screen Specific Styles */
        #custom-text-input {
            width: 100%;
            box-sizing: border-box;
            padding: 15px;
            font-size: 1em;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 20px;
            font-family: inherit;
            background-color: var(--card-bg);
            color: var(--text-color);
            transition: all 0.2s ease;
        }
        
        #custom-text-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
        }
        
        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .loading-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .loading-video {
            width: 300px;
            height: 300px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .loading-video video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .loading-text {
            color: #ffffff;
            font-size: 1.2em;
            margin-top: 10px;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s ease infinite;
            display: none; /* Hide spinner since we're using video */
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Heatmap Feature Styles */
        #heatmap-screen {
            background-color: var(--card-bg);
            padding: 40px;
            border-radius: 24px;
            box-shadow: var(--card-shadow);
            max-width: 800px;
            margin: 20px auto;
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #heatmap-screen h2 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-align: center;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        #heatmap-screen p {
            font-size: 1.1em;
            color: #cbd5e1;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .keyboard-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
        }
        
        .keyboard-row {
            display: flex;
            margin-bottom: 10px;
        }
        
        .key {
            width: 40px;
            height: 40px;
            margin: 3px;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 600;
            font-size: 0.9em;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .key::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease;
        }
        
        .key.space {
            width: 300px;
        }
        
        .key.heatmap-high {
            background: var(--heatmap-high);
        }
        
        .key.heatmap-medium {
            background: var(--heatmap-medium);
        }
        
        .key.heatmap-low {
            background: var(--heatmap-low);
        }
        
        .key.heatmap-good {
            background: var(--heatmap-good);
        }
        
        .key.heatmap-none {
            background: #9ca3af;
        }
        
        .heatmap-legend {
            display: flex;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 0 10px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 8px;
        }
        
        .legend-text {
            font-size: 0.9em;
            color: #cbd5e1;
        }
        
        .heatmap-stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin: 30px 0;
        }
        
        .heatmap-stat {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            min-width: 120px;
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .heatmap-stat-value {
            font-size: 1.8em;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .heatmap-stat-label {
            font-size: 0.9em;
            color: #cbd5e1;
            margin-top: 5px;
        }
        
        /* Typing Trend Analysis Styles */
        #trend-analysis-screen {
            background-color: var(--card-bg);
            padding: 40px;
            border-radius: 24px;
            box-shadow: var(--card-shadow);
            max-width: 800px;
            margin: 20px auto;
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #trend-analysis-screen h2 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-align: center;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        #trend-analysis-screen p {
            font-size: 1.1em;
            color: #cbd5e1;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .trend-chart-container {
            width: 100%;
            height: 300px;
            margin: 20px 0;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            position: relative;
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .trend-stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin: 30px 0;
        }
        
        .trend-stat {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            min-width: 120px;
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .trend-stat-value {
            font-size: 1.8em;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .trend-stat-label {
            font-size: 0.9em;
            color: #cbd5e1;
            margin-top: 5px;
        }
        
        /* Logout Confirmation Dialog */
        .logout-confirmation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }
        
        .logout-confirmation.active {
            opacity: 1;
            visibility: visible;
        }
        
        .logout-dialog {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            max-width: 400px;
            width: 90%;
            transition: all 0.2s ease;
            transform: scale(0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .logout-confirmation.active .logout-dialog {
            transform: scale(1);
        }
        
        .logout-dialog h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--text-color);
            text-align: center;
        }
        
        .logout-dialog p {
            margin-bottom: 30px;
            color: #cbd5e1;
            text-align: center;
        }
        
        .logout-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            header { flex-direction: column; gap: 10px; padding: 15px; }
            .card { padding: 20px; }
            .card h1, .card h2 { font-size: 1.8em; }
            .hero-stats { gap: 20px; }
            .hero-stat .stat-value { font-size: 2em; }
            #typing-area { font-size: 1.2em; max-height: 120px; }
            #stats { flex-wrap: wrap; gap: 15px; }
            .stat-value { font-size: 1.5em; }
            header nav a { padding: 8px 10px; gap: 5px; }
            header nav .nav-text { display: none; }
            .key {
                width: 30px;
                height: 30px;
                font-size: 0.8em;
            }
            .key.space {
                width: 200px;
            }
            .loading-video {
                width: 200px;
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- Background Video -->
    <div class="video-background">
        <video autoplay muted loop playsinline preload="metadata">
            <source src="backto.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>
    <div class="video-overlay"></div>
    
    <header>
        <div class="logo-container">
            <h1 class="logo">TypingPro</h1>
            <p class="subtitle">Power by ATIK APP STUDIO</p>
        </div>
        <nav>
            <div id="guest-nav">
                <a href="#" id="login-nav-btn"><i class="fas fa-sign-in-alt"></i><span class="nav-text">Login</span></a>
                <a href="#" id="register-nav-btn"><i class="fas fa-user-plus"></i><span class="nav-text">Register</span></a>
            </div>
            <div id="user-nav" class="hidden">
                <a href="#" id="home-link"><i class="fas fa-home"></i><span class="nav-text">Home</span></a>
                <a href="#" id="heatmap-link"><i class="fas fa-fire"></i><span class="nav-text">Heatmap</span></a>
                <a href="#" id="trend-analysis-link"><i class="fas fa-chart-line"></i><span class="nav-text">Trends</span></a>
                <a href="#" id="profile-link"><i class="fas fa-user-cog"></i><span class="nav-text">Profile</span></a>
                <a href="#" id="leaderboard-link"><i class="fas fa-trophy"></i><span class="nav-text">Leaderboard</span></a>
                <a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i><span class="nav-text">Logout</span></a>
            </div>
        </nav>
    </header>
    <main class="container">
        <section id="home-screen" class="card">
             <h1>Master Your Keystrokes</h1>
             <p>Select a test below or use your own text to practice.</p>
             <div class="hero-stats">
                 <div class="hero-stat">
                     <div class="stat-value" id="home-best-wpm">--</div>
                     <div class="stat-label">Best WPM</div>
                 </div>
                 <div class="hero-stat">
                     <div class="stat-value" id="home-tests-taken">--</div>
                     <div class="stat-label">Tests Taken</div>
                 </div>
             </div>
             <div class="presets-section">
                <h3 class="presets-title">Choose a Test Preset</h3>
                 <div class="preset-group">
                    <h4>Custom Text</h4>
                    <div class="preset-buttons">
                        <button id="custom-text-btn" class="btn btn-primary">Practice with Custom Text</button>
                    </div>
                </div>
                <div id="quick-start-buttons">
                    <div class="preset-group">
                        <h4>Time Tests</h4>
                        <div class="preset-buttons">
                            <select id="time-test-dropdown" class="btn btn-secondary" style="width: auto;">
                                <option value="" disabled selected>Select a duration...</option>
                                <option value="15">15 Seconds</option>
                                <option value="30">30 Seconds</option>
                                <option value="60">1 Minute</option>
                                <option value="120">2 Minutes</option>
                                <option value="180">3 Minutes</option>
                                <option value="300">5 Minutes</option>
                                <option value="600">10 Minutes</option>
                                <option value="900">15 Minutes</option>
                                <option value="1200">20 Minutes</option>
                            </select>
                        </div>
                    </div>
                    <div class="preset-group">
                        <h4>Words</h4>
                        <div class="preset-buttons">
                            <button class="btn btn-secondary" data-mode="words" data-count="50">50 words</button>
                        </div>
                    </div>
                </div>
             </div>
        </section>
        
        <section id="custom-text-screen" class="hidden card">
            <h2>Custom Text Practice</h2>
            <p>Paste your text below (minimum 20 characters) and start typing!</p>
            <textarea id="custom-text-input" rows="8" placeholder="Paste your text here..."></textarea>
            <div style="text-align: center;">
                <button id="start-custom-test-btn" class="btn btn-primary">Start Custom Test</button>
                <button id="custom-back-home-btn" class="btn btn-secondary">Back to Home</button>
            </div>
        </section>
        <section id="typing-test-screen" class="hidden">
            <div id="stats">
                <div class="stat"><div id="wpm" class="stat-value">0</div><div class="stat-label">WPM</div></div>
                <div class="stat"><div id="cpm" class="stat-value">0</div><div class="stat-label">CPM</div></div>
                <div class="stat"><div id="accuracy" class="stat-value">100</div><div class="stat-label">Accuracy</div></div>
                <div class="stat"><div id="timer" class="stat-value">0</div><div class="stat-label">Time</div></div>
                <div class="stat">
                    <button id="restart-test-btn" title="Restart Test"><i class="fas fa-redo"></i></button>
                </div>
            </div>
            <div id="typing-area">
                <div id="text-to-type"></div>
            </div>
            <textarea id="text-input" rows="1" spellcheck="false" autocorrect="off" autocapitalize="off"></textarea>
            <div style="text-align: center; margin-top: 20px;">
                <button id="end-test-btn" class="btn btn-primary">End Test</button>
            </div>
        </section>
        <section id="result-screen" class="hidden card">
            <h2>Test Results</h2>
            <div id="result-summary"></div>
            <button id="retry-btn" class="btn btn-primary">Try Again</button>
            <button id="view-heatmap-btn" class="btn btn-secondary">View Heatmap</button>
            <button id="view-trend-btn" class="btn btn-secondary">View Trends</button>
            <button id="home-btn" class="btn">Go Home</button>
        </section>
        
        <section id="heatmap-screen" class="hidden card">
            <h2>Typing Heatmap</h2>
            <p>Visualize your typing patterns and identify keys you struggle with.</p>
            
            <div class="heatmap-stats">
                <div class="heatmap-stat">
                    <div class="heatmap-stat-value" id="total-keystrokes">0</div>
                    <div class="heatmap-stat-label">Total Keystrokes</div>
                </div>
                <div class="heatmap-stat">
                    <div class="heatmap-stat-value" id="accuracy-rate">0%</div>
                    <div class="heatmap-stat-label">Accuracy Rate</div>
                </div>
                <div class="heatmap-stat">
                    <div class="heatmap-stat-value" id="problem-keys">0</div>
                    <div class="heatmap-stat-label">Problem Keys</div>
                </div>
            </div>
            
            <div class="keyboard-container">
                <div class="keyboard-row">
                    <div class="key" data-key="`">`</div>
                    <div class="key" data-key="1">1</div>
                    <div class="key" data-key="2">2</div>
                    <div class="key" data-key="3">3</div>
                    <div class="key" data-key="4">4</div>
                    <div class="key" data-key="5">5</div>
                    <div class="key" data-key="6">6</div>
                    <div class="key" data-key="7">7</div>
                    <div class="key" data-key="8">8</div>
                    <div class="key" data-key="9">9</div>
                    <div class="key" data-key="0">0</div>
                    <div class="key" data-key="-">-</div>
                    <div class="key" data-key="=">=</div>
                    <div class="key" data-key="Backspace">⌫</div>
                </div>
                <div class="keyboard-row">
                    <div class="key" data-key="Tab">Tab</div>
                    <div class="key" data-key="q">Q</div>
                    <div class="key" data-key="w">W</div>
                    <div class="key" data-key="e">E</div>
                    <div class="key" data-key="r">R</div>
                    <div class="key" data-key="t">T</div>
                    <div class="key" data-key="y">Y</div>
                    <div class="key" data-key="u">U</div>
                    <div class="key" data-key="i">I</div>
                    <div class="key" data-key="o">O</div>
                    <div class="key" data-key="p">P</div>
                    <div class="key" data-key="[">[</div>
                    <div class="key" data-key="]">]</div>
                    <div class="key" data-key="\">\</div>
                </div>
                <div class="keyboard-row">
                    <div class="key" data-key="CapsLock">Caps</div>
                    <div class="key" data-key="a">A</div>
                    <div class="key" data-key="s">S</div>
                    <div class="key" data-key="d">D</div>
                    <div class="key" data-key="f">F</div>
                    <div class="key" data-key="g">G</div>
                    <div class="key" data-key="h">H</div>
                    <div class="key" data-key="j">J</div>
                    <div class="key" data-key="k">K</div>
                    <div class="key" data-key="l">L</div>
                    <div class="key" data-key=";">;</div>
                    <div class="key" data-key="'">'</div>
                    <div class="key" data-key="Enter">Enter</div>
                </div>
                <div class="keyboard-row">
                    <div class="key" data-key="Shift">Shift</div>
                    <div class="key" data-key="z">Z</div>
                    <div class="key" data-key="x">X</div>
                    <div class="key" data-key="c">C</div>
                    <div class="key" data-key="v">V</div>
                    <div class="key" data-key="b">B</div>
                    <div class="key" data-key="n">N</div>
                    <div class="key" data-key="m">M</div>
                    <div class="key" data-key=",">,</div>
                    <div class="key" data-key=".">.</div>
                    <div class="key" data-key="/">/</div>
                    <div class="key" data-key="Shift">Shift</div>
                </div>
                <div class="keyboard-row">
                    <div class="key" data-key="Control">Ctrl</div>
                    <div class="key" data-key="Alt">Alt</div>
                    <div class="key space" data-key=" ">Space</div>
                    <div class="key" data-key="Alt">Alt</div>
                    <div class="key" data-key="Control">Ctrl</div>
                </div>
            </div>
            
            <div class="heatmap-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--heatmap-high);"></div>
                    <div class="legend-text">High Error Rate</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--heatmap-medium);"></div>
                    <div class="legend-text">Medium Error Rate</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--heatmap-low);"></div>
                    <div class="legend-text">Low Error Rate</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--heatmap-good);"></div>
                    <div class="legend-text">Good Accuracy</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--card-shadow);"></div>
                    <div class="legend-text">No Data</div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button id="heatmap-back-home-btn" class="btn btn-secondary">Go Home</button>
            </div>
        </section>
        
        <section id="trend-analysis-screen" class="hidden card">
            <h2>Typing Trend Analysis</h2>
            <p>Track your typing performance over time and see your improvement trends.</p>
            
            <div class="trend-stats">
                <div class="trend-stat">
                    <div class="trend-stat-value" id="avg-wpm">0</div>
                    <div class="trend-stat-label">Average WPM</div>
                </div>
                <div class="trend-stat">
                    <div class="trend-stat-value" id="improvement-rate">0%</div>
                    <div class="trend-stat-label">Improvement Rate</div>
                </div>
                <div class="trend-stat">
                    <div class="trend-stat-value" id="consistency-score">0%</div>
                    <div class="trend-stat-label">Consistency Score</div>
                </div>
            </div>
            
            <div class="trend-chart-container">
                <canvas id="trend-chart"></canvas>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button id="trend-back-home-btn" class="btn btn-secondary">Go Home</button>
            </div>
        </section>
        
        <section id="login-screen" class="hidden card">
            <h2>Login</h2>
            <form id="login-form">
                <div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" required></div>
                <div class="form-group"><label for="login-password">Password</label><input type="password" id="login-password" required></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
                <p id="login-error" class="error-message hidden"></p>
                <p class="form-switch-link">Don't have an account? <a id="go-to-register">Register</a></p>
            </form>
        </section>
        <section id="register-screen" class="hidden card">
            <h2>Register</h2>
            <form id="register-form">
                <div class="form-group"><label for="register-email">Email</label><input type="email" id="register-email" required></div>
                <div class="form-group"><label for="register-password">Password</label><input type="password" id="register-password" required></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Register</button>
                <p id="register-error" class="error-message hidden"></p>
                <p class="form-switch-link">Already have an account? <a id="go-to-login">Login</a></p>
            </form>
        </section>
        <section id="leaderboard-screen" class="hidden card">
            <h2>Leaderboards</h2>
            <p>See who is the fastest for each test duration.</p>
            
            <div class="leaderboard-tabs" id="leaderboard-tabs">
                <button class="btn-secondary active" data-mode="time" data-duration="15">15s</button>
                <button class="btn-secondary" data-mode="time" data-duration="30">30s</button>
                <button class="btn-secondary" data-mode="time" data-duration="60">1 min</button>
                <button class="btn-secondary" data-mode="time" data-duration="120">2 min</button>
                <button class="btn-secondary" data-mode="time" data-duration="180">3 min</button>
                <button class="btn-secondary" data-mode="time" data-duration="300">5 min</button>
                <button class="btn-secondary" data-mode="time" data-duration="600">10 min</button>
                <button class="btn-secondary" data-mode="time" data-duration="900">15 min</button>
                <button class="btn-secondary" data-mode="time" data-duration="1200">20 min</button>
            </div>
            <div id="leaderboard-content">
                <h3 id="leaderboard-title">Top 3 Typists</h3>
                <ol id="leaderboard-list"></ol>
            </div>
        </section>
        <section id="profile-screen" class="hidden card">
            <h2>My Profile</h2>
            <p id="profile-email">user@example.com</p>
            <div id="profile-stats-container"></div>
            <button id="profile-back-home-btn" class="btn btn-secondary">Go Home</button>
        </section>
    </main>
    
    <!-- Loading Overlay with Video -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="loading-video">
                <video id="loading-video-element" autoplay muted loop playsinline>
                    <source src="see.mp4" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
            <div class="loading-text" id="loading-text">Loading...</div>
        </div>
    </div>
    
    <!-- Auth Loading Overlay with Video -->
    <div id="auth-loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="loading-video">
                <video id="auth-loading-video-element" autoplay muted loop playsinline>
                    <source src="logon.mp4" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
            <div class="loading-text" id="auth-loading-text">Authenticating...</div>
        </div>
    </div>
    
    <button id="dark-mode-toggle" class="dark-mode-toggle">
        <i class="fas fa-moon"></i>
    </button>
    
    <!-- Logout Confirmation Dialog -->
    <div id="logout-confirmation" class="logout-confirmation">
        <div class="logout-dialog">
            <h3>Confirm Logout</h3>
            <p>Are you sure you want to logout?</p>
            <div class="logout-buttons">
                <button id="confirm-logout" class="btn btn-primary">Yes, Logout</button>
                <button id="cancel-logout" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDZrP8uuHQOSlU5rnQqmJ-_mKYs6GaO_AA",
            authDomain: "all-app-er.firebaseapp.com",
            databaseURL: "https://all-app-er-default-rtdb.firebaseio.com",
            projectId: "all-app-er",
            storageBucket: "all-app-er.appspot.com",
            messagingSenderId: "166378015396",
            appId: "1:166378015396:web:48cfb3cfa81611d7627431"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        // --- Paragraphs for Typing Test ---
        const textPool = [
            "The quick brown fox jumps over the lazy dog. This sentence contains every letter of the alphabet.",
            "A journey of a thousand miles begins with a single step. Lao Tzu said this to emphasize that great things start with small beginnings.",
            "To be or not to be that is the question. A famous line from William Shakespeare's play Hamlet.",
            "The internet has revolutionized the way we live, work, and communicate. It connects billions of people worldwide.",
            "Artificial intelligence is no longer the realm of science fiction; it is an integral part of our daily lives.",
            "Cloud computing has fundamentally changed the information technology landscape by offering scalability and flexibility.",
            "The early bird catches the worm. This proverb suggests that starting something early gives you a better chance of success.",
            "Actions speak louder than words. It is more important what you do than what you say.",
            "Honesty is the best policy. It is always better to tell the truth, even when it is difficult.",
            "Practice makes perfect. The more you do something, the better you will become at it.",
            "Where there is a will there is a way. If you are determined enough, you can find a way to achieve what you want."
        ];
        
        let endlessModeTextPool = [];
        // --- DOM Elements & State ---
        const allScreens = document.querySelectorAll('main > section');
        const textToType = document.getElementById('text-to-type');
        const textInput = document.getElementById('text-input');
        const loadingOverlay = document.getElementById('loading-overlay');
        const authLoadingOverlay = document.getElementById('auth-loading-overlay');
        const timeTestDropdown = document.getElementById('time-test-dropdown');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const logoutConfirmation = document.getElementById('logout-confirmation');
        const loadingText = document.getElementById('loading-text');
        const authLoadingText = document.getElementById('auth-loading-text');
        let currentScreenId = 'home-screen';
        let timerInterval, testActive, startTime, lastTestConfig = {}, mistakes, typedChars;
        let keyStats = {}; // Object to store key statistics for heatmap
        let currentTestKeyStats = {}; // Key stats for current test
        let trendChart = null; // Chart.js instance for trend analysis
        
        // Optimize video loading
        function optimizeVideoLoading() {
            const backgroundVideo = document.querySelector('.video-background video');
            
            // Set preload to metadata for faster loading
            backgroundVideo.setAttribute('preload', 'metadata');
            
            // Load video with higher priority
            if ('requestIdleCallback' in window) {
                requestIdleCallback(() => {
                    backgroundVideo.load();
                });
            } else {
                // Fallback for browsers that don't support requestIdleCallback
                setTimeout(() => {
                    backgroundVideo.load();
                }, 100);
            }
        }
        
        // Initialize video optimization
        document.addEventListener('DOMContentLoaded', () => {
            optimizeVideoLoading();
            
            // Set up video event listeners
            const backgroundVideo = document.querySelector('.video-background video');
            backgroundVideo.addEventListener('loadeddata', () => {
                console.log('Background video loaded successfully');
            });
            
            backgroundVideo.addEventListener('error', (e) => {
                console.error('Error loading background video:', e);
            });
        });
        
        // --- START: Navigation and History Management ---
        function showScreen(screenId, pushState = true) {
            if (!document.getElementById(screenId)) {
                console.error("Screen not found:", screenId);
                return;
            }
            allScreens.forEach(screen => screen.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            currentScreenId = screenId;
            if (pushState) {
                const newPath = (screenId === 'home-screen') ? window.location.pathname : `#${screenId}`;
                history.pushState({ screen: screenId }, '', newPath);
            }
            updateActiveNav(screenId);
        }
        
        function updateActiveNav(screenId) {
            document.querySelectorAll('#user-nav a').forEach(link => link.classList.remove('nav-active'));
            let activeLink;
            switch(screenId) {
                case 'home-screen': case 'custom-text-screen': case 'typing-test-screen': case 'result-screen':
                    activeLink = document.getElementById('home-link'); break;
                case 'profile-screen': activeLink = document.getElementById('profile-link'); break;
                case 'leaderboard-screen': activeLink = document.getElementById('leaderboard-link'); break;
                case 'heatmap-screen': activeLink = document.getElementById('heatmap-link'); break;
                case 'trend-analysis-screen': activeLink = document.getElementById('trend-analysis-link'); break;
            }
            if (activeLink) activeLink.classList.add('nav-active');
        }
        
        window.addEventListener('popstate', (event) => {
            const targetScreen = (event.state && event.state.screen) || 'home-screen';
            showScreen(targetScreen, false);
        });
        
        function navigateHome() { showScreen('home-screen', true); }
        // --- END: Navigation and History Management ---
        
        function showLoading(text = "Loading...") {
            loadingText.textContent = text;
            loadingOverlay.classList.remove('hidden');
            
            // Ensure video is playing
            const loadingVideo = document.getElementById('loading-video-element');
            if (loadingVideo) {
                loadingVideo.play().catch(e => console.log("Video play failed:", e));
            }
        }
        
        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }
        
        function showAuthLoading(text = "Authenticating...") {
            authLoadingText.textContent = text;
            authLoadingOverlay.classList.remove('hidden');
            
            // Ensure video is playing
            const authLoadingVideo = document.getElementById('auth-loading-video-element');
            if (authLoadingVideo) {
                authLoadingVideo.play().catch(e => console.log("Auth video play failed:", e));
            }
        }
        
        function hideAuthLoading() {
            authLoadingOverlay.classList.add('hidden');
        }
        
        function generateMoreText() {
            if (endlessModeTextPool.length === 0) {
                endlessModeTextPool = shuffleArray(textPool);
            }
            const newText = endlessModeTextPool.pop();
            const spaceSpan = document.createElement('span');
            spaceSpan.innerText = ' ';
            textToType.appendChild(spaceSpan);
            newText.split('').forEach(char => {
                const span = document.createElement('span');
                span.innerText = char;
                textToType.appendChild(span);
            });
        }
        
        function restartTest() {
            if (!testActive) return;
            clearInterval(timerInterval);
            startTest(lastTestConfig.mode, lastTestConfig.value, lastTestConfig.customText);
        }
        
        function shuffleArray(arr) { return [...arr].sort(() => Math.random() - 0.5); }
        
        function setupTextForTest(text) {
            textToType.innerHTML = '';
            text.split('').forEach(char => {
                const span = document.createElement('span');
                span.innerText = char;
                textToType.appendChild(span);
            });
        }
        
        function startTest(mode, value, customText = null) {
            lastTestConfig = { mode, value, customText };
            testActive = true;
            startTime = null;
            mistakes = 0;
            typedChars = 0;
            currentTestKeyStats = {}; // Reset key stats for this test
            textInput.value = '';
            textInput.disabled = false;
            
            let textToUse;
            if (customText) {
                textToUse = customText;
            } else if (mode === 'time') {
                endlessModeTextPool = shuffleArray(textPool);
                textToUse = endlessModeTextPool.slice(0, 3).join(" ");
            } else {
                textToUse = shuffleArray(textPool).slice(0, 10).join(" ");
            }
            setupTextForTest(textToUse);
            showScreen('typing-test-screen');
            textInput.focus();
            
            let timerLabel = "0";
            if (mode === 'time') timerLabel = value;
            document.getElementById('timer').innerText = timerLabel;
            
            updateCursor();
            resetLiveStats();
        }
        
        function endTest() {
            if (!testActive) return;
            testActive = false;
            clearInterval(timerInterval);
            textInput.disabled = true;
            const results = calculateFinalStats();
            displayResults(results);
            saveResultsToFirebase(results, lastTestConfig);
            showScreen('result-screen');
            
            // Reset dropdown to default after test is finished
            timeTestDropdown.value = ""; 
        }
        
        function calculateFinalStats() {
            if (!startTime) return { wpm: 0, cpm: 0, accuracy: 100, mistakes: 0 };
            const timeElapsedSeconds = (new Date().getTime() - startTime) / 1000;
            const correctChars = typedChars - mistakes;
            const wpm = timeElapsedSeconds > 0 ? Math.round((correctChars / 5) / (timeElapsedSeconds / 60)) : 0;
            const cpm = timeElapsedSeconds > 0 ? Math.round(correctChars / (timeElapsedSeconds / 60)) : 0;
            const accuracy = typedChars > 0 ? Math.round((correctChars / typedChars) * 100) : 100;
            return { wpm, cpm, accuracy: Math.max(0, accuracy), mistakes };
        }
        
        function displayResults({ wpm, cpm, accuracy, mistakes }) {
            const resultSummary = document.getElementById('result-summary');
            resultSummary.innerHTML = `
                <div class="result-stat"><div class="stat-value">${wpm}</div><div class="stat-label">WPM</div></div>
                <div class="result-stat"><div class="stat-value">${cpm}</div><div class="stat-label">CPM</div></div>
                <div class="result-stat"><div class="stat-value">${accuracy}%</div><div class="stat-label">Accuracy</div></div>
                <div class="result-stat"><div class="stat-value">${mistakes}</div><div class="stat-label">Mistakes</div></div>`;
        }
        
        function updateLiveStats() {
            if (!startTime) return;
            const stats = calculateFinalStats();
            document.getElementById('wpm').innerText = stats.wpm;
            document.getElementById('cpm').innerText = stats.cpm;
            document.getElementById('accuracy').innerText = stats.accuracy;
        }
        
        function resetLiveStats() {
            document.getElementById('wpm').innerText = 0;
            document.getElementById('cpm').innerText = 0;
            document.getElementById('accuracy').innerText = 100;
        }
        
        function updateCursor() {
            const textSpans = textToType.querySelectorAll('span');
            textSpans.forEach(span => span.classList.remove('current'));
            const currentPos = textInput.value.length;
            if (currentPos < textSpans.length) {
                const cursorSpan = textSpans[currentPos];
                cursorSpan.classList.add('current');
                cursorSpan.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
        
        // --- Firebase & Auth Logic ---
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('guest-nav').classList.add('hidden');
                document.getElementById('user-nav').classList.remove('hidden');
                fetchUserStats(user.uid);
                fetchKeyStats(user.uid);
            } else {
                document.getElementById('guest-nav').classList.remove('hidden');
                document.getElementById('user-nav').classList.add('hidden');
                document.getElementById('home-best-wpm').innerText = '--';
                document.getElementById('home-tests-taken').innerText = '--';
            }
            if (currentScreenId !== 'home-screen' && !user) {
                 showScreen('home-screen', false);
                 history.replaceState({screen: 'home-screen'}, '', window.location.pathname);
            }
            updateActiveNav(currentScreenId);
        });
        
        function fetchUserStats(uid) {
            db.ref(`users/${uid}`).once('value', snapshot => {
                if (snapshot.exists()) {
                    const stats = snapshot.val();
                    document.getElementById('home-best-wpm').innerText = stats.overallBestWpm || 0;
                    document.getElementById('home-tests-taken').innerText = stats.testsTaken || 0;
                }
            });
        }
        
        function fetchKeyStats(uid) {
            db.ref(`keyStats/${uid}`).once('value', snapshot => {
                if (snapshot.exists()) {
                    keyStats = snapshot.val();
                } else {
                    keyStats = {};
                }
            });
        }
        
        function saveKeyStatsToFirebase(uid) {
            if (!uid || Object.keys(currentTestKeyStats).length === 0) return;
            
            // Merge current test stats with existing stats
            Object.keys(currentTestKeyStats).forEach(key => {
                if (!keyStats[key]) {
                    keyStats[key] = {
                        correct: 0,
                        incorrect: 0,
                        total: 0
                    };
                }
                
                keyStats[key].correct += currentTestKeyStats[key].correct || 0;
                keyStats[key].incorrect += currentTestKeyStats[key].incorrect || 0;
                keyStats[key].total += currentTestKeyStats[key].total || 0;
            });
            
            // Save to Firebase
            db.ref(`keyStats/${uid}`).set(keyStats);
        }
        
        async function saveResultsToFirebase(results, { mode, value }) {
            const user = auth.currentUser;
            if (!user || results.wpm === 0 || !mode || !value || mode === 'custom') return;
            
            // Save key stats
            saveKeyStatsToFirebase(user.uid);
            
            const testKey = `${mode}_${value}`;
            const userStatsRef = db.ref(`users/${user.uid}`);
            const leaderboardRef = db.ref(`testLeaderboards/${testKey}`);
            
            try {
                // Update user's personal stats
                const snapshot = await userStatsRef.once('value');
                const stats = snapshot.val() || { email: user.email, testsTaken: 0, overallBestWpm: 0, scores: {} };
                const currentBestForTest = (stats.scores && stats.scores[testKey]) ? stats.scores[testKey] : { wpm: 0 };
                
                if (results.wpm > currentBestForTest.wpm) {
                    if (!stats.scores) stats.scores = {};
                    stats.scores[testKey] = results;
                }
                
                const newOverallBest = Math.max(stats.overallBestWpm || 0, results.wpm);
                const updates = {
                    testsTaken: (stats.testsTaken || 0) + 1,
                    overallBestWpm: newOverallBest,
                    scores: stats.scores,
                    email: user.email
                };
                await userStatsRef.update(updates);
                
                // Update the test-specific leaderboard
                const leaderboardSnapshot = await leaderboardRef.orderByChild('wpm').once('value');
                const scores = [];
                leaderboardSnapshot.forEach(child => {
                    scores.push({
                        ...child.val(),
                        key: child.key
                    });
                });
                const userExistingScore = scores.find(score => score.userId === user.uid);
                
                if (userExistingScore) {
                    if (results.wpm > userExistingScore.wpm) {
                        await leaderboardRef.child(userExistingScore.key).update({
                            wpm: results.wpm,
                            accuracy: results.accuracy,
                        });
                    }
                } else {
                    await leaderboardRef.push({
                        email: user.email,
                        wpm: results.wpm,
                        accuracy: results.accuracy,
                        userId: user.uid
                    });
                }
                
                // Trim leaderboard to top 3
                const finalLeaderboardSnapshot = await leaderboardRef.orderByChild('wpm').once('value');
                const finalScores = [];
                finalLeaderboardSnapshot.forEach(child => {
                    finalScores.push({
                        ...child.val(),
                        key: child.key
                    });
                });
                
                finalScores.sort((a, b) => b.wpm - a.wpm);
                
                if (finalScores.length > 3) {
                    for (let i = 3; i < finalScores.length; i++) {
                        await leaderboardRef.child(finalScores[i].key).remove();
                    }
                }
                
                fetchUserStats(user.uid);
            } catch (error) {
                console.error("Error saving results: ", error);
            }
        }
        
        function showLeaderboardScreen() {
            showLoading("Loading leaderboard...");
            setTimeout(() => {
                showScreen('leaderboard-screen');
                const firstButton = document.querySelector('#leaderboard-tabs button');
                if (firstButton) {
                    firstButton.click();
                }
                hideLoading();
            }, 500);
        }
        
        async function displayLeaderboardForTest(mode, duration) {
            const testKey = `${mode}_${duration}`;
            const leaderboardList = document.getElementById('leaderboard-list');
            const leaderboardTitle = document.getElementById('leaderboard-title');
            
            let titleText;
            if (duration < 60) {
                titleText = `Top Typists for ${duration} Seconds`;
            } else {
                const minutes = duration / 60;
                titleText = `Top Typists for ${minutes} Minute${minutes > 1 ? 's' : ''}`;
            }
            leaderboardTitle.innerText = titleText;
            leaderboardList.innerHTML = '<li>Loading...</li>';
            try {
                const leaderboardRef = db.ref(`testLeaderboards/${testKey}`).orderByChild('wpm');
                const snapshot = await leaderboardRef.once('value');
                
                if (snapshot.exists()) {
                    const scoresArray = [];
                    snapshot.forEach(child => {
                        scoresArray.push(child.val());
                    });
                    
                    const sortedScores = scoresArray.sort((a, b) => b.wpm - a.wpm).slice(0, 3);
                    
                    const medals = ['🥇', '🥈', '🥉'];
                    leaderboardList.innerHTML = sortedScores.map((score, index) =>
                        `<li>
                            <span class="rank">${medals[index] || (index + 1) + '.'}</span>
                            <span class="email">${score.email}</span>
                            <span class="wpm">${score.wpm} WPM</span>
                        </li>`
                    ).join('');
                } else { 
                    leaderboardList.innerHTML = '<li>No scores yet for this category. Be the first!</li>'; 
                }
            } catch (error) {
                console.error(`Failed to load leaderboard for ${testKey}:`, error);
                leaderboardList.innerHTML = '<li>Could not load scores. Please try again later.</li>';
            }
        }
        
        async function showProfileScreen() {
            const user = auth.currentUser;
            if (!user) { showScreen('login-screen'); return; }
            
            showLoading("Loading profile...");
            setTimeout(async () => {
                showScreen('profile-screen');
                const profileContainer = document.getElementById('profile-stats-container');
                document.getElementById('profile-email').innerText = user.email;
                profileContainer.innerHTML = '<p>Loading your best scores...</p>';
                const createLabelFromKey = (key) => {
                    const [type, value] = key.split('_');
                    if (type === 'time') {
                        const seconds = parseInt(value, 10);
                        return seconds >= 60 ? `${seconds / 60} Minute${seconds > 60 ? 's' : ''} Best` : `${seconds} Second${seconds > 1 ? 's' : ''} Best`;
                    }
                    return type === 'words' ? `${value} Word${parseInt(value, 10) > 1 ? 's' : ''} Best` : key;
                };
                try {
                    const snapshot = await db.ref(`users/${user.uid}/scores`).once('value');
                    const scores = snapshot.val() || {};
                    const scoreKeys = Object.keys(scores);
                    let profileHtml = '';
                    if (scoreKeys.length === 0) {
                         profileHtml = '<p>You have not completed any tests yet. Go take one!</p>';
                    } else {
                        scoreKeys.sort((a, b) => {
                            const [typeA, valA] = a.split('_');
                            const [typeB, valB] = b.split('_');
                            if (typeA !== typeB) return typeA.localeCompare(typeB);
                            return parseInt(valA, 10) - parseInt(valB, 10);
                        }).forEach(key => {
                            const scoreData = scores[key];
                            if (scoreData) {
                                profileHtml += `
                                    <div class="profile-test-record">
                                        <h3>${createLabelFromKey(key)}</h3>
                                        <div class="stats-grid">
                                            <div><span class="stat-value">${scoreData.wpm}</span><span class="stat-label">WPM</span></div>
                                            <div><span class="stat-value">${scoreData.cpm}</span><span class="stat-label">CPM</span></div>
                                            <div><span class="stat-value">${scoreData.accuracy}%</span><span class="stat-label">Accuracy</span></div>
                                            <div><span class="stat-value">${scoreData.mistakes}</span><span class="stat-label">Mistakes</span></div>
                                        </div>
                                    </div>`;
                            }
                        });
                    }
                    profileContainer.innerHTML = profileHtml || '<p>You have not completed any tests yet. Go take one!</p>';
                } catch (error) {
                    console.error("Could not load profile stats:", error);
                    profileContainer.innerHTML = '<p>Could not load your stats. Please try again.</p>';
                }
                hideLoading();
            }, 500);
        }
        
        function showHeatmapScreen() {
            const user = auth.currentUser;
            if (!user) { 
                showScreen('login-screen'); 
                return; 
            }
            
            showLoading("Loading heatmap...");
            setTimeout(() => {
                showScreen('heatmap-screen');
                updateHeatmap();
                hideLoading();
            }, 500);
        }
        
        function updateHeatmap() {
            // Calculate heatmap statistics
            let totalKeystrokes = 0;
            let totalMistakes = 0;
            let problemKeysCount = 0;
            
            // Update each key on the heatmap
            document.querySelectorAll('.key').forEach(keyElement => {
                const keyValue = keyElement.getAttribute('data-key');
                
                // Remove all heatmap classes
                keyElement.classList.remove('heatmap-high', 'heatmap-medium', 'heatmap-low', 'heatmap-good', 'heatmap-none');
                
                if (keyStats[keyValue] && keyStats[keyValue].total > 0) {
                    const accuracy = keyStats[keyValue].correct / keyStats[keyValue].total;
                    totalKeystrokes += keyStats[keyValue].total;
                    totalMistakes += keyStats[keyValue].incorrect;
                    
                    if (accuracy < 0.7) {
                        keyElement.classList.add('heatmap-high');
                        problemKeysCount++;
                    } else if (accuracy < 0.85) {
                        keyElement.classList.add('heatmap-medium');
                        problemKeysCount++;
                    } else if (accuracy < 0.95) {
                        keyElement.classList.add('heatmap-low');
                    } else {
                        keyElement.classList.add('heatmap-good');
                    }
                } else {
                    keyElement.classList.add('heatmap-none');
                }
            });
            
            // Update heatmap statistics
            document.getElementById('total-keystrokes').innerText = totalKeystrokes;
            document.getElementById('accuracy-rate').innerText = totalKeystrokes > 0 ? 
                Math.round((1 - totalMistakes / totalKeystrokes) * 100) + '%' : '0%';
            document.getElementById('problem-keys').innerText = problemKeysCount;
        }
        
        function showTrendAnalysisScreen() {
            const user = auth.currentUser;
            if (!user) { 
                showScreen('login-screen'); 
                return; 
            }
            
            showLoading("Loading trends...");
            setTimeout(() => {
                showScreen('trend-analysis-screen');
                updateTrendAnalysis(user.uid);
                hideLoading();
            }, 500);
        }
        
        async function updateTrendAnalysis(uid) {
            try {
                // Fetch user's test history
                const snapshot = await db.ref(`users/${uid}/scores`).once('value');
                const scores = snapshot.val() || {};
                
                // Calculate statistics
                let totalWpm = 0;
                let testCount = 0;
                let wpmValues = [];
                
                Object.keys(scores).forEach(key => {
                    const scoreData = scores[key];
                    if (scoreData && scoreData.wpm) {
                        totalWpm += scoreData.wpm;
                        testCount++;
                        wpmValues.push(scoreData.wpm);
                    }
                });
                
                const avgWpm = testCount > 0 ? Math.round(totalWpm / testCount) : 0;
                document.getElementById('avg-wpm').innerText = avgWpm;
                
                // Calculate improvement rate (simplified)
                const improvementRate = testCount > 1 ? 
                    Math.round(((wpmValues[wpmValues.length - 1] - wpmValues[0]) / wpmValues[0]) * 100) : 0;
                document.getElementById('improvement-rate').innerText = improvementRate + '%';
                
                // Calculate consistency score (standard deviation)
                let consistencyScore = 100;
                if (testCount > 1) {
                    const mean = totalWpm / testCount;
                    let variance = 0;
                    wpmValues.forEach(wpm => {
                        variance += Math.pow(wpm - mean, 2);
                    });
                    const stdDev = Math.sqrt(variance / testCount);
                    consistencyScore = Math.max(0, Math.round(100 - (stdDev / mean) * 100));
                }
                document.getElementById('consistency-score').innerText = consistencyScore + '%';
                
                // Create or update chart
                const ctx = document.getElementById('trend-chart').getContext('2d');
                
                if (trendChart) {
                    trendChart.destroy();
                }
                
                // Prepare chart data
                const labels = Object.keys(scores).map(key => {
                    const [type, value] = key.split('_');
                    if (type === 'time') {
                        const seconds = parseInt(value, 10);
                        return seconds >= 60 ? `${seconds / 60} min` : `${seconds} sec`;
                    }
                    return key;
                });
                
                const data = Object.keys(scores).map(key => scores[key].wpm);
                
                trendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'WPM',
                            data: data,
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                            pointBorderColor: '#fff',
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.7)',
                                titleFont: {
                                    size: 14
                                },
                                bodyFont: {
                                    size: 14
                                },
                                padding: 10,
                                cornerRadius: 5
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error("Error updating trend analysis:", error);
                document.getElementById('avg-wpm').innerText = '0';
                document.getElementById('improvement-rate').innerText = '0%';
                document.getElementById('consistency-score').innerText = '0%';
            }
        }
        
        // --- Event Listeners ---
        function preventDefault(e) { e.preventDefault(); }
        
        document.querySelector('.logo-container').addEventListener('click', (e) => { preventDefault(e); navigateHome(); });
        document.getElementById('login-nav-btn').addEventListener('click', (e) => { preventDefault(e); showScreen('login-screen'); });
        document.getElementById('register-nav-btn').addEventListener('click', (e) => { preventDefault(e); showScreen('register-screen'); });
        document.getElementById('leaderboard-link').addEventListener('click', (e) => { preventDefault(e); showLeaderboardScreen(); });
        document.getElementById('heatmap-link').addEventListener('click', (e) => { preventDefault(e); showHeatmapScreen(); });
        document.getElementById('trend-analysis-link').addEventListener('click', (e) => { preventDefault(e); showTrendAnalysisScreen(); });
        document.getElementById('home-link').addEventListener('click', (e) => { preventDefault(e); navigateHome(); });
        document.getElementById('home-btn').addEventListener('click', (e) => { preventDefault(e); navigateHome(); });
        document.getElementById('profile-link').addEventListener('click', (e) => { preventDefault(e); showProfileScreen(); });
        document.getElementById('profile-back-home-btn').addEventListener('click', (e) => { preventDefault(e); navigateHome(); });
        document.getElementById('heatmap-back-home-btn').addEventListener('click', (e) => { preventDefault(e); navigateHome(); });
        document.getElementById('trend-back-home-btn').addEventListener('click', (e) => { preventDefault(e); navigateHome(); });
        document.getElementById('go-to-register').addEventListener('click', (e) => { preventDefault(e); showScreen('register-screen'); });
        document.getElementById('go-to-login').addEventListener('click', (e) => { preventDefault(e); showScreen('login-screen'); });
        
        // Logout confirmation
        document.getElementById('logout-btn').addEventListener('click', (e) => {
            preventDefault(e);
            logoutConfirmation.classList.add('active');
        });
        
        document.getElementById('confirm-logout').addEventListener('click', (e) => {
            preventDefault(e);
            logoutConfirmation.classList.remove('active');
            auth.signOut().then(navigateHome);
        });
        
        document.getElementById('cancel-logout').addEventListener('click', (e) => {
            preventDefault(e);
            logoutConfirmation.classList.remove('active');
        });
        
        // Close logout dialog when clicking outside
        logoutConfirmation.addEventListener('click', (e) => {
            if (e.target === logoutConfirmation) {
                logoutConfirmation.classList.remove('active');
            }
        });
        
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            preventDefault(e);
            showAuthLoading("Logging in...");
            const errEl = document.getElementById('login-error');
            errEl.classList.add('hidden');
            try {
                await auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value);
                hideAuthLoading();
                navigateHome();
            } catch (err) {
                errEl.innerText = err.message;
                errEl.classList.remove('hidden');
                hideAuthLoading();
            }
        });
        
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            preventDefault(e);
            showAuthLoading("Creating account...");
            const errEl = document.getElementById('register-error');
            errEl.classList.add('hidden');
            try {
                await auth.createUserWithEmailAndPassword(document.getElementById('register-email').value, document.getElementById('register-password').value);
                hideAuthLoading();
                navigateHome();
            } catch (err) {
                errEl.innerText = err.message;
                errEl.classList.remove('hidden');
                hideAuthLoading();
            }
        });
        
        document.getElementById('quick-start-buttons').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.mode) {
                startTest(e.target.dataset.mode, parseInt(e.target.dataset.duration || e.target.dataset.count, 10));
            }
        });
        
        timeTestDropdown.addEventListener('change', (e) => {
            const duration = parseInt(e.target.value, 10);
            if (!isNaN(duration)) {
                startTest('time', duration);
            }
        });
        
        document.getElementById('custom-text-btn').addEventListener('click', () => showScreen('custom-text-screen'));
        document.getElementById('custom-back-home-btn').addEventListener('click', navigateHome);
        document.getElementById('start-custom-test-btn').addEventListener('click', () => {
            const customText = document.getElementById('custom-text-input').value.trim();
            if (customText.length >= 20) {
                startTest('custom', customText.length, customText);
            } else {
                alert('Please paste at least 20 characters of text to start.');
            }
        });
        
        document.getElementById('retry-btn').addEventListener('click', () => {
             if (lastTestConfig.mode) {
                startTest(lastTestConfig.mode, lastTestConfig.value, lastTestConfig.customText);
             } else {
                navigateHome();
             }
        });
        
        document.getElementById('view-heatmap-btn').addEventListener('click', () => {
            showHeatmapScreen();
        });
        
        document.getElementById('view-trend-btn').addEventListener('click', () => {
            showTrendAnalysisScreen();
        });
        
        document.getElementById('end-test-btn').addEventListener('click', endTest);
        document.getElementById('restart-test-btn').addEventListener('click', restartTest);
        
        document.getElementById('leaderboard-tabs').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                document.querySelectorAll('#leaderboard-tabs button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                const mode = e.target.dataset.mode;
                const duration = parseInt(e.target.dataset.duration, 10);
                displayLeaderboardForTest(mode, duration);
            }
        });
        
        textInput.addEventListener('input', () => {
            if (!testActive) return;
            
            if (!startTime) {
                startTime = new Date().getTime();
                if (lastTestConfig.mode === 'time') {
                     timerInterval = setInterval(() => {
                        const timeElapsed = Math.floor((new Date().getTime() - startTime) / 1000);
                        const timeRemaining = lastTestConfig.value - timeElapsed;
                        document.getElementById('timer').innerText = Math.max(0, timeRemaining);
                        if (timeRemaining <= 0) endTest();
                    }, 1000);
                }
            }
            
            const originalTextSpans = textToType.querySelectorAll('span');
            const currentTypedText = textInput.value;
            typedChars = currentTypedText.length;
            mistakes = 0;
            
            currentTypedText.split('').forEach((typedChar, index) => {
                if (index < originalTextSpans.length) {
                    const originalChar = originalTextSpans[index].innerText;
                    originalTextSpans[index].className = (typedChar === originalChar) ? 'correct' : 'incorrect';
                    if (typedChar !== originalChar) mistakes++;
                    
                    // Track key statistics for heatmap
                    const key = typedChar.toLowerCase();
                    if (!currentTestKeyStats[key]) {
                        currentTestKeyStats[key] = {
                            correct: 0,
                            incorrect: 0,
                            total: 0
                        };
                    }
                    
                    currentTestKeyStats[key].total++;
                    if (typedChar === originalChar) {
                        currentTestKeyStats[key].correct++;
                    } else {
                        currentTestKeyStats[key].incorrect++;
                    }
                }
            });
            
            for (let i = typedChars; i < originalTextSpans.length; i++) {
                originalTextSpans[i].className = '';
            }
            
            if (lastTestConfig.mode === 'time' && typedChars > originalTextSpans.length - 50) {
                generateMoreText();
            }
            
            if ((lastTestConfig.mode === 'words' || lastTestConfig.mode === 'custom') && typedChars === originalTextSpans.length) {
                endTest();
            }
            
            updateCursor();
            updateLiveStats();
        });
        
        // Initial Load
        document.addEventListener('DOMContentLoaded', () => {
            const initialScreen = window.location.hash.substring(1) || 'home-screen';
            if (document.getElementById(initialScreen)) {
                showScreen(initialScreen, false);
                history.replaceState({ screen: initialScreen }, '', window.location.pathname + (initialScreen !== 'home-screen' ? `#${initialScreen}` : ''));
            } else {
                showScreen('home-screen', false);
                history.replaceState({ screen: 'home-screen' }, '', window.location.pathname);
            }
        });
    </script>
</body>
</html>
